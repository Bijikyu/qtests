c43776ad4128245e99c386be4e815ca2
"use strict";
/**
 * qtests Setup Module - Global Node.js Module Resolution Modification - TypeScript Implementation
 *
 * This module modifies Node.js's global module resolution behavior to automatically
 * substitute stub implementations for real modules during testing. It's a critical
 * piece of the qtests framework that enables seamless testing without changing
 * application code.
 *
 * Core functionality:
 * When this module is required, it patches Node.js's Module._resolveFilename method
 * to intercept require() calls and redirect them to stub implementations when
 * appropriate. This allows test code to use the same require() statements as
 * production code while getting test-appropriate implementations.
 *
 * Design philosophy:
 * - Transparent operation: Application code doesn't need to change
 * - Automatic stub resolution: No manual require() path changes needed
 * - Safe operation: Only affects specific modules, others work normally
 * - Performance conscious: Minimal overhead on module resolution
 *
 * Security and safety considerations:
 * - Only affects modules in the predefined stub registry
 * - Original Node.js behavior preserved for unlisted modules
 * - Changes are temporary and isolated to test execution
 * - No permanent modifications to Node.js installation
 * - Easy to disable by not requiring this module
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.setupComplete = void 0;
// Import Node.js Module constructor for accessing module resolution internals
// This gives us access to the private _resolveFilename method that controls
// how Node.js resolves module names to file paths
const module_1 = __importDefault(require("module"));
const path_1 = __importDefault(require("path"));
const esm_globals_js_1 = require("./utils/esm-globals.js");
// Get current directory for ES modules
const __dirname = (0, esm_globals_js_1.getModuleDirname)(import.meta.url);
const stubsPath = path_1.default.join(__dirname, 'stubs');
const STUB_REGISTRY = {
    axios: 'axios.js', // HTTP client library stub file name for quick lookup
    winston: 'winston.js' // logging library stub file name for quick lookup
};
// Preserve existing NODE_PATH if it exists
const currentNodePath = process.env.NODE_PATH || '';
// Determine correct path separator for current platform
const separator = process.platform === 'win32' ? ';' : ':';
// Prepend our stubs directory to NODE_PATH
process.env.NODE_PATH = stubsPath + (currentNodePath ? separator + currentNodePath : '');
// Force Node.js to recognize the updated NODE_PATH for dynamic module resolution
module_1.default._initPaths();
// Store original Module._load function for delegation to maintain normal module loading behavior
const origLoad = module_1.default._load;
/**
 * Enhanced Module._load replacement that handles stub substitution
 *
 * This function intercepts all module loading requests and redirects known
 * modules to their stub implementations when appropriate.
 */
module_1.default._load = function (id, parent, isMain) {
    // Check if this module should be stubbed
    if (STUB_REGISTRY[id]) {
        const stubPath = path_1.default.join(stubsPath, STUB_REGISTRY[id]);
        try {
            // Load the stub module instead of the real one
            return origLoad.call(this, stubPath, parent, isMain);
        }
        catch (error) {
            console.log(`qtests: Failed to load stub for ${id} from ${stubPath}, falling back to original`);
            // Fall back to original module if stub loading fails
            return origLoad.call(this, id, parent, isMain);
        }
    }
    // For non-stubbed modules, use original behavior
    return origLoad.call(this, id, parent, isMain);
};
console.log('qtests: Global module resolution patching activated');
console.log(`qtests: Stub registry contains: ${Object.keys(STUB_REGISTRY).join(', ')}`);
console.log(`qtests: Stubs directory: ${stubsPath}`);
// Export setup completion indicator
exports.setupComplete = true;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXR1cC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBMEJHOzs7Ozs7QUFFSCw4RUFBOEU7QUFDOUUsNEVBQTRFO0FBQzVFLGtEQUFrRDtBQUNsRCxvREFBNEI7QUFDNUIsZ0RBQXdCO0FBQ3hCLDJEQUEwRDtBQUUxRCx1Q0FBdUM7QUFDdkMsTUFBTSxTQUFTLEdBQUcsSUFBQSxpQ0FBZ0IsRUFBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3BELE1BQU0sU0FBUyxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBYWhELE1BQU0sYUFBYSxHQUFpQjtJQUNsQyxLQUFLLEVBQUUsVUFBVSxFQUFFLHNEQUFzRDtJQUN6RSxPQUFPLEVBQUUsWUFBWSxDQUFDLGtEQUFrRDtDQUN6RSxDQUFDO0FBRUYsMkNBQTJDO0FBQzNDLE1BQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQztBQUVwRCx3REFBd0Q7QUFDeEQsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFFBQVEsS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO0FBRTNELDJDQUEyQztBQUMzQyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxTQUFTLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLFNBQVMsR0FBRyxlQUFlLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBRXpGLGlGQUFpRjtBQUNoRixnQkFBYyxDQUFDLFVBQVUsRUFBRSxDQUFDO0FBRTdCLGlHQUFpRztBQUNqRyxNQUFNLFFBQVEsR0FBSSxnQkFBYyxDQUFDLEtBQUssQ0FBQztBQUV2Qzs7Ozs7R0FLRztBQUNGLGdCQUFjLENBQUMsS0FBSyxHQUFHLFVBQVMsRUFBVSxFQUFFLE1BQVcsRUFBRSxNQUFnQjtJQUN4RSx5Q0FBeUM7SUFDekMsSUFBSSxhQUFhLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUN0QixNQUFNLFFBQVEsR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUM7WUFDSCwrQ0FBK0M7WUFDL0MsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3ZELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsRUFBRSxTQUFTLFFBQVEsNEJBQTRCLENBQUMsQ0FBQztZQUNoRyxxREFBcUQ7WUFDckQsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ2pELENBQUM7SUFDSCxDQUFDO0lBRUQsaURBQWlEO0lBQ2pELE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztBQUNqRCxDQUFDLENBQUM7QUFFRixPQUFPLENBQUMsR0FBRyxDQUFDLHFEQUFxRCxDQUFDLENBQUM7QUFDbkUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3hGLE9BQU8sQ0FBQyxHQUFHLENBQUMsNEJBQTRCLFNBQVMsRUFBRSxDQUFDLENBQUM7QUFFckQsb0NBQW9DO0FBQ3ZCLFFBQUEsYUFBYSxHQUFHLElBQUksQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3NldHVwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogcXRlc3RzIFNldHVwIE1vZHVsZSAtIEdsb2JhbCBOb2RlLmpzIE1vZHVsZSBSZXNvbHV0aW9uIE1vZGlmaWNhdGlvbiAtIFR5cGVTY3JpcHQgSW1wbGVtZW50YXRpb25cbiAqIFxuICogVGhpcyBtb2R1bGUgbW9kaWZpZXMgTm9kZS5qcydzIGdsb2JhbCBtb2R1bGUgcmVzb2x1dGlvbiBiZWhhdmlvciB0byBhdXRvbWF0aWNhbGx5XG4gKiBzdWJzdGl0dXRlIHN0dWIgaW1wbGVtZW50YXRpb25zIGZvciByZWFsIG1vZHVsZXMgZHVyaW5nIHRlc3RpbmcuIEl0J3MgYSBjcml0aWNhbFxuICogcGllY2Ugb2YgdGhlIHF0ZXN0cyBmcmFtZXdvcmsgdGhhdCBlbmFibGVzIHNlYW1sZXNzIHRlc3Rpbmcgd2l0aG91dCBjaGFuZ2luZ1xuICogYXBwbGljYXRpb24gY29kZS5cbiAqIFxuICogQ29yZSBmdW5jdGlvbmFsaXR5OlxuICogV2hlbiB0aGlzIG1vZHVsZSBpcyByZXF1aXJlZCwgaXQgcGF0Y2hlcyBOb2RlLmpzJ3MgTW9kdWxlLl9yZXNvbHZlRmlsZW5hbWUgbWV0aG9kXG4gKiB0byBpbnRlcmNlcHQgcmVxdWlyZSgpIGNhbGxzIGFuZCByZWRpcmVjdCB0aGVtIHRvIHN0dWIgaW1wbGVtZW50YXRpb25zIHdoZW5cbiAqIGFwcHJvcHJpYXRlLiBUaGlzIGFsbG93cyB0ZXN0IGNvZGUgdG8gdXNlIHRoZSBzYW1lIHJlcXVpcmUoKSBzdGF0ZW1lbnRzIGFzXG4gKiBwcm9kdWN0aW9uIGNvZGUgd2hpbGUgZ2V0dGluZyB0ZXN0LWFwcHJvcHJpYXRlIGltcGxlbWVudGF0aW9ucy5cbiAqIFxuICogRGVzaWduIHBoaWxvc29waHk6XG4gKiAtIFRyYW5zcGFyZW50IG9wZXJhdGlvbjogQXBwbGljYXRpb24gY29kZSBkb2Vzbid0IG5lZWQgdG8gY2hhbmdlXG4gKiAtIEF1dG9tYXRpYyBzdHViIHJlc29sdXRpb246IE5vIG1hbnVhbCByZXF1aXJlKCkgcGF0aCBjaGFuZ2VzIG5lZWRlZFxuICogLSBTYWZlIG9wZXJhdGlvbjogT25seSBhZmZlY3RzIHNwZWNpZmljIG1vZHVsZXMsIG90aGVycyB3b3JrIG5vcm1hbGx5XG4gKiAtIFBlcmZvcm1hbmNlIGNvbnNjaW91czogTWluaW1hbCBvdmVyaGVhZCBvbiBtb2R1bGUgcmVzb2x1dGlvblxuICogXG4gKiBTZWN1cml0eSBhbmQgc2FmZXR5IGNvbnNpZGVyYXRpb25zOlxuICogLSBPbmx5IGFmZmVjdHMgbW9kdWxlcyBpbiB0aGUgcHJlZGVmaW5lZCBzdHViIHJlZ2lzdHJ5XG4gKiAtIE9yaWdpbmFsIE5vZGUuanMgYmVoYXZpb3IgcHJlc2VydmVkIGZvciB1bmxpc3RlZCBtb2R1bGVzXG4gKiAtIENoYW5nZXMgYXJlIHRlbXBvcmFyeSBhbmQgaXNvbGF0ZWQgdG8gdGVzdCBleGVjdXRpb25cbiAqIC0gTm8gcGVybWFuZW50IG1vZGlmaWNhdGlvbnMgdG8gTm9kZS5qcyBpbnN0YWxsYXRpb25cbiAqIC0gRWFzeSB0byBkaXNhYmxlIGJ5IG5vdCByZXF1aXJpbmcgdGhpcyBtb2R1bGVcbiAqL1xuXG4vLyBJbXBvcnQgTm9kZS5qcyBNb2R1bGUgY29uc3RydWN0b3IgZm9yIGFjY2Vzc2luZyBtb2R1bGUgcmVzb2x1dGlvbiBpbnRlcm5hbHNcbi8vIFRoaXMgZ2l2ZXMgdXMgYWNjZXNzIHRvIHRoZSBwcml2YXRlIF9yZXNvbHZlRmlsZW5hbWUgbWV0aG9kIHRoYXQgY29udHJvbHNcbi8vIGhvdyBOb2RlLmpzIHJlc29sdmVzIG1vZHVsZSBuYW1lcyB0byBmaWxlIHBhdGhzXG5pbXBvcnQgTW9kdWxlIGZyb20gJ21vZHVsZSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGdldE1vZHVsZURpcm5hbWUgfSBmcm9tICcuL3V0aWxzL2VzbS1nbG9iYWxzLmpzJztcblxuLy8gR2V0IGN1cnJlbnQgZGlyZWN0b3J5IGZvciBFUyBtb2R1bGVzXG5jb25zdCBfX2Rpcm5hbWUgPSBnZXRNb2R1bGVEaXJuYW1lKGltcG9ydC5tZXRhLnVybCk7XG5jb25zdCBzdHVic1BhdGggPSBwYXRoLmpvaW4oX19kaXJuYW1lLCAnc3R1YnMnKTtcblxuLyoqXG4gKiBNb2R1bGUgc3R1YiByZWdpc3RyeSAtIGRlZmluZXMgd2hpY2ggbW9kdWxlcyBzaG91bGQgYmUgcmVwbGFjZWQgd2l0aCBzdHVic1xuICogXG4gKiBUaGlzIG9iamVjdCBtYXBzIHJlYWwgbW9kdWxlIG5hbWVzIHRvIHRoZWlyIHN0dWIgaW1wbGVtZW50YXRpb24gcGF0aHMuXG4gKiBXaGVuIE5vZGUuanMgYXR0ZW1wdHMgdG8gcmVzb2x2ZSBhIG1vZHVsZSBsaXN0ZWQgaW4gdGhpcyByZWdpc3RyeSxcbiAqIHRoZSBzdHViIHBhdGggd2lsbCBiZSByZXR1cm5lZCBpbnN0ZWFkIG9mIHRoZSByZWFsIG1vZHVsZSBwYXRoLlxuICovXG5pbnRlcmZhY2UgU3R1YlJlZ2lzdHJ5IHtcbiAgW21vZHVsZU5hbWU6IHN0cmluZ106IHN0cmluZztcbn1cblxuY29uc3QgU1RVQl9SRUdJU1RSWTogU3R1YlJlZ2lzdHJ5ID0ge1xuICBheGlvczogJ2F4aW9zLmpzJywgLy8gSFRUUCBjbGllbnQgbGlicmFyeSBzdHViIGZpbGUgbmFtZSBmb3IgcXVpY2sgbG9va3VwXG4gIHdpbnN0b246ICd3aW5zdG9uLmpzJyAvLyBsb2dnaW5nIGxpYnJhcnkgc3R1YiBmaWxlIG5hbWUgZm9yIHF1aWNrIGxvb2t1cFxufTtcblxuLy8gUHJlc2VydmUgZXhpc3RpbmcgTk9ERV9QQVRIIGlmIGl0IGV4aXN0c1xuY29uc3QgY3VycmVudE5vZGVQYXRoID0gcHJvY2Vzcy5lbnYuTk9ERV9QQVRIIHx8ICcnO1xuXG4vLyBEZXRlcm1pbmUgY29ycmVjdCBwYXRoIHNlcGFyYXRvciBmb3IgY3VycmVudCBwbGF0Zm9ybVxuY29uc3Qgc2VwYXJhdG9yID0gcHJvY2Vzcy5wbGF0Zm9ybSA9PT0gJ3dpbjMyJyA/ICc7JyA6ICc6JztcblxuLy8gUHJlcGVuZCBvdXIgc3R1YnMgZGlyZWN0b3J5IHRvIE5PREVfUEFUSFxucHJvY2Vzcy5lbnYuTk9ERV9QQVRIID0gc3R1YnNQYXRoICsgKGN1cnJlbnROb2RlUGF0aCA/IHNlcGFyYXRvciArIGN1cnJlbnROb2RlUGF0aCA6ICcnKTtcblxuLy8gRm9yY2UgTm9kZS5qcyB0byByZWNvZ25pemUgdGhlIHVwZGF0ZWQgTk9ERV9QQVRIIGZvciBkeW5hbWljIG1vZHVsZSByZXNvbHV0aW9uXG4oTW9kdWxlIGFzIGFueSkuX2luaXRQYXRocygpO1xuXG4vLyBTdG9yZSBvcmlnaW5hbCBNb2R1bGUuX2xvYWQgZnVuY3Rpb24gZm9yIGRlbGVnYXRpb24gdG8gbWFpbnRhaW4gbm9ybWFsIG1vZHVsZSBsb2FkaW5nIGJlaGF2aW9yXG5jb25zdCBvcmlnTG9hZCA9IChNb2R1bGUgYXMgYW55KS5fbG9hZDtcblxuLyoqXG4gKiBFbmhhbmNlZCBNb2R1bGUuX2xvYWQgcmVwbGFjZW1lbnQgdGhhdCBoYW5kbGVzIHN0dWIgc3Vic3RpdHV0aW9uXG4gKiBcbiAqIFRoaXMgZnVuY3Rpb24gaW50ZXJjZXB0cyBhbGwgbW9kdWxlIGxvYWRpbmcgcmVxdWVzdHMgYW5kIHJlZGlyZWN0cyBrbm93blxuICogbW9kdWxlcyB0byB0aGVpciBzdHViIGltcGxlbWVudGF0aW9ucyB3aGVuIGFwcHJvcHJpYXRlLlxuICovXG4oTW9kdWxlIGFzIGFueSkuX2xvYWQgPSBmdW5jdGlvbihpZDogc3RyaW5nLCBwYXJlbnQ6IGFueSwgaXNNYWluPzogYm9vbGVhbik6IGFueSB7XG4gIC8vIENoZWNrIGlmIHRoaXMgbW9kdWxlIHNob3VsZCBiZSBzdHViYmVkXG4gIGlmIChTVFVCX1JFR0lTVFJZW2lkXSkge1xuICAgIGNvbnN0IHN0dWJQYXRoID0gcGF0aC5qb2luKHN0dWJzUGF0aCwgU1RVQl9SRUdJU1RSWVtpZF0pO1xuICAgIHRyeSB7XG4gICAgICAvLyBMb2FkIHRoZSBzdHViIG1vZHVsZSBpbnN0ZWFkIG9mIHRoZSByZWFsIG9uZVxuICAgICAgcmV0dXJuIG9yaWdMb2FkLmNhbGwodGhpcywgc3R1YlBhdGgsIHBhcmVudCwgaXNNYWluKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5sb2coYHF0ZXN0czogRmFpbGVkIHRvIGxvYWQgc3R1YiBmb3IgJHtpZH0gZnJvbSAke3N0dWJQYXRofSwgZmFsbGluZyBiYWNrIHRvIG9yaWdpbmFsYCk7XG4gICAgICAvLyBGYWxsIGJhY2sgdG8gb3JpZ2luYWwgbW9kdWxlIGlmIHN0dWIgbG9hZGluZyBmYWlsc1xuICAgICAgcmV0dXJuIG9yaWdMb2FkLmNhbGwodGhpcywgaWQsIHBhcmVudCwgaXNNYWluKTtcbiAgICB9XG4gIH1cbiAgXG4gIC8vIEZvciBub24tc3R1YmJlZCBtb2R1bGVzLCB1c2Ugb3JpZ2luYWwgYmVoYXZpb3JcbiAgcmV0dXJuIG9yaWdMb2FkLmNhbGwodGhpcywgaWQsIHBhcmVudCwgaXNNYWluKTtcbn07XG5cbmNvbnNvbGUubG9nKCdxdGVzdHM6IEdsb2JhbCBtb2R1bGUgcmVzb2x1dGlvbiBwYXRjaGluZyBhY3RpdmF0ZWQnKTtcbmNvbnNvbGUubG9nKGBxdGVzdHM6IFN0dWIgcmVnaXN0cnkgY29udGFpbnM6ICR7T2JqZWN0LmtleXMoU1RVQl9SRUdJU1RSWSkuam9pbignLCAnKX1gKTtcbmNvbnNvbGUubG9nKGBxdGVzdHM6IFN0dWJzIGRpcmVjdG9yeTogJHtzdHVic1BhdGh9YCk7XG5cbi8vIEV4cG9ydCBzZXR1cCBjb21wbGV0aW9uIGluZGljYXRvclxuZXhwb3J0IGNvbnN0IHNldHVwQ29tcGxldGUgPSB0cnVlOyJdLCJ2ZXJzaW9uIjozfQ==