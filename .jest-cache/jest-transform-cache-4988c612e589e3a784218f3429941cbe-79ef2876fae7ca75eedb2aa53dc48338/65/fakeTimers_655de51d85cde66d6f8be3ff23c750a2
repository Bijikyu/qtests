58d5e15461b7d629dc92315033624a7e
"use strict";
/**
 * Fake Timers - Time Control for Testing
 *
 * This module provides Jest/Sinon-compatible fake timer functionality
 * allowing tests to control time and timer execution for deterministic testing.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.clearAllTimers = exports.advanceTimersToNextTimer = void 0;
exports.useFakeTimers = useFakeTimers;
exports.useRealTimers = useRealTimers;
exports.setSystemTime = setSystemTime;
exports.advanceTimersByTime = advanceTimersByTime;
exports.runAllTimers = runAllTimers;
exports.runOnlyPendingTimers = runOnlyPendingTimers;
exports.getTimerCount = getTimerCount;
exports.now = now;
// Timer state management
class FakeTimerState {
    constructor() {
        this.currentTime = 0;
        this.timerIdCounter = 1;
        this.timers = new Map();
        this.originalTimers = null;
    }
    /**
     * Install fake timers, replacing global timer functions
     */
    useFakeTimers() {
        if (this.originalTimers) {
            return; // Already using fake timers
        }
        // Store original implementations
        this.originalTimers = {
            setTimeout: global.setTimeout,
            clearTimeout: global.clearTimeout,
            setInterval: global.setInterval,
            clearInterval: global.clearInterval,
            setImmediate: global.setImmediate,
            clearImmediate: global.clearImmediate,
            Date: global.Date
        };
        // Replace global timer functions
        global.setTimeout = this.createSetTimeout();
        global.clearTimeout = this.createClearTimeout();
        global.setInterval = this.createSetInterval();
        global.clearInterval = this.createClearInterval();
        global.setImmediate = this.createSetImmediate();
        global.clearImmediate = this.createClearImmediate();
        // Replace Date constructor to use fake time
        const fakeDate = this.createFakeDate();
        global.Date = fakeDate;
    }
    /**
     * Restore real timers
     */
    useRealTimers() {
        if (!this.originalTimers) {
            return; // Not using fake timers
        }
        // Restore original implementations
        global.setTimeout = this.originalTimers.setTimeout;
        global.clearTimeout = this.originalTimers.clearTimeout;
        global.setInterval = this.originalTimers.setInterval;
        global.clearInterval = this.originalTimers.clearInterval;
        global.setImmediate = this.originalTimers.setImmediate;
        global.clearImmediate = this.originalTimers.clearImmediate;
        global.Date = this.originalTimers.Date;
        this.originalTimers = null;
        this.clearAllTimers();
    }
    /**
     * Set the current system time
     */
    setSystemTime(time) {
        this.currentTime = typeof time === 'number' ? time : time.getTime();
    }
    /**
     * Get current fake time
     */
    now() {
        return this.currentTime;
    }
    /**
     * Advance timers by specified amount
     */
    advanceTimersByTime(msToRun) {
        const targetTime = this.currentTime + msToRun;
        while (this.currentTime < targetTime) {
            const nextTimer = this.getNextTimer();
            if (!nextTimer || nextTimer.executeAt > targetTime) {
                // No more timers to execute within the time range
                this.currentTime = targetTime;
                break;
            }
            // Execute the next timer
            this.currentTime = nextTimer.executeAt;
            this.executeTimer(nextTimer);
        }
    }
    /**
     * Run all pending timers
     */
    runAllTimers() {
        while (this.timers.size > 0) {
            const nextTimer = this.getNextTimer();
            if (!nextTimer)
                break;
            this.currentTime = nextTimer.executeAt;
            this.executeTimer(nextTimer);
        }
    }
    /**
     * Run only currently pending timers (not new ones created during execution)
     */
    runOnlyPendingTimers() {
        const pendingTimers = Array.from(this.timers.values()).sort((a, b) => a.executeAt - b.executeAt);
        for (const timer of pendingTimers) {
            if (this.timers.has(timer.id)) { // Check if still active
                this.currentTime = timer.executeAt;
                this.executeTimer(timer);
            }
        }
    }
    /**
     * Get the number of pending timers
     */
    getTimerCount() {
        return this.timers.size;
    }
    // Private helper methods
    createSetTimeout() {
        return (callback, delay = 0, ...args) => {
            const id = this.timerIdCounter++;
            const task = {
                id,
                type: 'timeout',
                callback,
                delay,
                args,
                scheduledAt: this.currentTime,
                executeAt: this.currentTime + Math.max(0, delay),
                isActive: true
            };
            this.timers.set(id, task);
            return id;
        };
    }
    createClearTimeout() {
        return (id) => {
            this.timers.delete(id);
        };
    }
    createSetInterval() {
        return (callback, delay = 0, ...args) => {
            const id = this.timerIdCounter++;
            const task = {
                id,
                type: 'interval',
                callback,
                delay: Math.max(1, delay), // Intervals must have at least 1ms delay
                args,
                scheduledAt: this.currentTime,
                executeAt: this.currentTime + Math.max(1, delay),
                isActive: true
            };
            this.timers.set(id, task);
            return id;
        };
    }
    createClearInterval() {
        return (id) => {
            this.timers.delete(id);
        };
    }
    createSetImmediate() {
        return (callback, ...args) => {
            const id = this.timerIdCounter++;
            const task = {
                id,
                type: 'timeout',
                callback,
                delay: 0,
                args,
                scheduledAt: this.currentTime,
                executeAt: this.currentTime, // Immediate execution
                isActive: true
            };
            this.timers.set(id, task);
            return id;
        };
    }
    createClearImmediate() {
        return (id) => {
            this.timers.delete(id);
        };
    }
    createFakeDate() {
        const state = this;
        function FakeDate(...args) {
            if (args.length === 0) {
                return new state.originalTimers.Date(state.currentTime);
            }
            else {
                return new state.originalTimers.Date(...args);
            }
        }
        // Copy static methods from real Date
        FakeDate.now = () => state.currentTime;
        FakeDate.parse = state.originalTimers.Date.parse;
        FakeDate.UTC = state.originalTimers.Date.UTC;
        FakeDate.prototype = state.originalTimers.Date.prototype;
        return FakeDate;
    }
    getNextTimer() {
        let nextTimer = null;
        for (const timer of this.timers.values()) {
            if (timer.isActive && (!nextTimer || timer.executeAt < nextTimer.executeAt)) {
                nextTimer = timer;
            }
        }
        return nextTimer;
    }
    executeTimer(timer) {
        if (!timer.isActive || !this.timers.has(timer.id)) {
            return;
        }
        try {
            timer.callback(...timer.args);
        }
        catch (error) {
            // Timer errors should not stop fake timer execution
            console.error('Timer callback error:', error);
        }
        if (timer.type === 'timeout') {
            // Remove one-time timers
            this.timers.delete(timer.id);
        }
        else {
            // Reschedule intervals
            timer.executeAt = this.currentTime + timer.delay;
        }
    }
    clearAllTimers() {
        this.timers.clear();
        this.currentTime = 0;
        this.timerIdCounter = 1;
    }
}
// Global fake timer instance
const globalFakeTimers = new FakeTimerState();
// Public API functions
function useFakeTimers() {
    globalFakeTimers.useFakeTimers();
}
function useRealTimers() {
    globalFakeTimers.useRealTimers();
}
function setSystemTime(time) {
    globalFakeTimers.setSystemTime(time);
}
function advanceTimersByTime(msToRun) {
    globalFakeTimers.advanceTimersByTime(msToRun);
}
function runAllTimers() {
    globalFakeTimers.runAllTimers();
}
function runOnlyPendingTimers() {
    globalFakeTimers.runOnlyPendingTimers();
}
function getTimerCount() {
    return globalFakeTimers.getTimerCount();
}
// Alias for Jest compatibility
exports.advanceTimersToNextTimer = runOnlyPendingTimers;
exports.clearAllTimers = useRealTimers;
// Get current fake time
function now() {
    return globalFakeTimers.now();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,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ZS9ydW5uZXIvd29ya3NwYWNlL2xpYi90aW1lcnMvZmFrZVRpbWVycy50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEZha2UgVGltZXJzIC0gVGltZSBDb250cm9sIGZvciBUZXN0aW5nXG4gKiBcbiAqIFRoaXMgbW9kdWxlIHByb3ZpZGVzIEplc3QvU2lub24tY29tcGF0aWJsZSBmYWtlIHRpbWVyIGZ1bmN0aW9uYWxpdHlcbiAqIGFsbG93aW5nIHRlc3RzIHRvIGNvbnRyb2wgdGltZSBhbmQgdGltZXIgZXhlY3V0aW9uIGZvciBkZXRlcm1pbmlzdGljIHRlc3RpbmcuXG4gKi9cblxuLy8gVGltZXIgdGFzayB0eXBlc1xuaW50ZXJmYWNlIFRpbWVyVGFzayB7XG4gIGlkOiBudW1iZXI7XG4gIHR5cGU6ICd0aW1lb3V0JyB8ICdpbnRlcnZhbCc7XG4gIGNhbGxiYWNrOiAoLi4uYXJnczogYW55W10pID0+IHZvaWQ7XG4gIGRlbGF5OiBudW1iZXI7XG4gIGFyZ3M6IGFueVtdO1xuICBzY2hlZHVsZWRBdDogbnVtYmVyO1xuICBleGVjdXRlQXQ6IG51bWJlcjtcbiAgaXNBY3RpdmU6IGJvb2xlYW47XG59XG5cbi8vIFRpbWVyIHN0YXRlIG1hbmFnZW1lbnRcbmNsYXNzIEZha2VUaW1lclN0YXRlIHtcbiAgcHJpdmF0ZSBjdXJyZW50VGltZSA9IDA7XG4gIHByaXZhdGUgdGltZXJJZENvdW50ZXIgPSAxO1xuICBwcml2YXRlIHRpbWVycyA9IG5ldyBNYXA8bnVtYmVyLCBUaW1lclRhc2s+KCk7XG4gIHByaXZhdGUgb3JpZ2luYWxUaW1lcnM6IHtcbiAgICBzZXRUaW1lb3V0OiB0eXBlb2YgZ2xvYmFsLnNldFRpbWVvdXQ7XG4gICAgY2xlYXJUaW1lb3V0OiB0eXBlb2YgZ2xvYmFsLmNsZWFyVGltZW91dDtcbiAgICBzZXRJbnRlcnZhbDogdHlwZW9mIGdsb2JhbC5zZXRJbnRlcnZhbDtcbiAgICBjbGVhckludGVydmFsOiB0eXBlb2YgZ2xvYmFsLmNsZWFySW50ZXJ2YWw7XG4gICAgc2V0SW1tZWRpYXRlOiB0eXBlb2YgZ2xvYmFsLnNldEltbWVkaWF0ZTtcbiAgICBjbGVhckltbWVkaWF0ZTogdHlwZW9mIGdsb2JhbC5jbGVhckltbWVkaWF0ZTtcbiAgICBEYXRlOiB0eXBlb2YgZ2xvYmFsLkRhdGU7XG4gIH0gfCBudWxsID0gbnVsbDtcbiAgXG4gIC8qKlxuICAgKiBJbnN0YWxsIGZha2UgdGltZXJzLCByZXBsYWNpbmcgZ2xvYmFsIHRpbWVyIGZ1bmN0aW9uc1xuICAgKi9cbiAgdXNlRmFrZVRpbWVycygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5vcmlnaW5hbFRpbWVycykge1xuICAgICAgcmV0dXJuOyAvLyBBbHJlYWR5IHVzaW5nIGZha2UgdGltZXJzXG4gICAgfVxuICAgIFxuICAgIC8vIFN0b3JlIG9yaWdpbmFsIGltcGxlbWVudGF0aW9uc1xuICAgIHRoaXMub3JpZ2luYWxUaW1lcnMgPSB7XG4gICAgICBzZXRUaW1lb3V0OiBnbG9iYWwuc2V0VGltZW91dCxcbiAgICAgIGNsZWFyVGltZW91dDogZ2xvYmFsLmNsZWFyVGltZW91dCxcbiAgICAgIHNldEludGVydmFsOiBnbG9iYWwuc2V0SW50ZXJ2YWwsXG4gICAgICBjbGVhckludGVydmFsOiBnbG9iYWwuY2xlYXJJbnRlcnZhbCxcbiAgICAgIHNldEltbWVkaWF0ZTogZ2xvYmFsLnNldEltbWVkaWF0ZSxcbiAgICAgIGNsZWFySW1tZWRpYXRlOiBnbG9iYWwuY2xlYXJJbW1lZGlhdGUsXG4gICAgICBEYXRlOiBnbG9iYWwuRGF0ZVxuICAgIH07XG4gICAgXG4gICAgLy8gUmVwbGFjZSBnbG9iYWwgdGltZXIgZnVuY3Rpb25zXG4gICAgZ2xvYmFsLnNldFRpbWVvdXQgPSB0aGlzLmNyZWF0ZVNldFRpbWVvdXQoKTtcbiAgICBnbG9iYWwuY2xlYXJUaW1lb3V0ID0gdGhpcy5jcmVhdGVDbGVhclRpbWVvdXQoKTtcbiAgICBnbG9iYWwuc2V0SW50ZXJ2YWwgPSB0aGlzLmNyZWF0ZVNldEludGVydmFsKCk7XG4gICAgZ2xvYmFsLmNsZWFySW50ZXJ2YWwgPSB0aGlzLmNyZWF0ZUNsZWFySW50ZXJ2YWwoKTtcbiAgICBnbG9iYWwuc2V0SW1tZWRpYXRlID0gdGhpcy5jcmVhdGVTZXRJbW1lZGlhdGUoKTtcbiAgICBnbG9iYWwuY2xlYXJJbW1lZGlhdGUgPSB0aGlzLmNyZWF0ZUNsZWFySW1tZWRpYXRlKCk7XG4gICAgXG4gICAgLy8gUmVwbGFjZSBEYXRlIGNvbnN0cnVjdG9yIHRvIHVzZSBmYWtlIHRpbWVcbiAgICBjb25zdCBmYWtlRGF0ZSA9IHRoaXMuY3JlYXRlRmFrZURhdGUoKTtcbiAgICBnbG9iYWwuRGF0ZSA9IGZha2VEYXRlIGFzIGFueTtcbiAgfVxuICBcbiAgLyoqXG4gICAqIFJlc3RvcmUgcmVhbCB0aW1lcnNcbiAgICovXG4gIHVzZVJlYWxUaW1lcnMoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLm9yaWdpbmFsVGltZXJzKSB7XG4gICAgICByZXR1cm47IC8vIE5vdCB1c2luZyBmYWtlIHRpbWVyc1xuICAgIH1cbiAgICBcbiAgICAvLyBSZXN0b3JlIG9yaWdpbmFsIGltcGxlbWVudGF0aW9uc1xuICAgIGdsb2JhbC5zZXRUaW1lb3V0ID0gdGhpcy5vcmlnaW5hbFRpbWVycy5zZXRUaW1lb3V0O1xuICAgIGdsb2JhbC5jbGVhclRpbWVvdXQgPSB0aGlzLm9yaWdpbmFsVGltZXJzLmNsZWFyVGltZW91dDtcbiAgICBnbG9iYWwuc2V0SW50ZXJ2YWwgPSB0aGlzLm9yaWdpbmFsVGltZXJzLnNldEludGVydmFsO1xuICAgIGdsb2JhbC5jbGVhckludGVydmFsID0gdGhpcy5vcmlnaW5hbFRpbWVycy5jbGVhckludGVydmFsO1xuICAgIGdsb2JhbC5zZXRJbW1lZGlhdGUgPSB0aGlzLm9yaWdpbmFsVGltZXJzLnNldEltbWVkaWF0ZTtcbiAgICBnbG9iYWwuY2xlYXJJbW1lZGlhdGUgPSB0aGlzLm9yaWdpbmFsVGltZXJzLmNsZWFySW1tZWRpYXRlO1xuICAgIGdsb2JhbC5EYXRlID0gdGhpcy5vcmlnaW5hbFRpbWVycy5EYXRlO1xuICAgIFxuICAgIHRoaXMub3JpZ2luYWxUaW1lcnMgPSBudWxsO1xuICAgIHRoaXMuY2xlYXJBbGxUaW1lcnMoKTtcbiAgfVxuICBcbiAgLyoqXG4gICAqIFNldCB0aGUgY3VycmVudCBzeXN0ZW0gdGltZVxuICAgKi9cbiAgc2V0U3lzdGVtVGltZSh0aW1lOiBudW1iZXIgfCBEYXRlKTogdm9pZCB7XG4gICAgdGhpcy5jdXJyZW50VGltZSA9IHR5cGVvZiB0aW1lID09PSAnbnVtYmVyJyA/IHRpbWUgOiB0aW1lLmdldFRpbWUoKTtcbiAgfVxuICBcbiAgLyoqXG4gICAqIEdldCBjdXJyZW50IGZha2UgdGltZVxuICAgKi9cbiAgbm93KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudFRpbWU7XG4gIH1cbiAgXG4gIC8qKlxuICAgKiBBZHZhbmNlIHRpbWVycyBieSBzcGVjaWZpZWQgYW1vdW50XG4gICAqL1xuICBhZHZhbmNlVGltZXJzQnlUaW1lKG1zVG9SdW46IG51bWJlcik6IHZvaWQge1xuICAgIGNvbnN0IHRhcmdldFRpbWUgPSB0aGlzLmN1cnJlbnRUaW1lICsgbXNUb1J1bjtcbiAgICBcbiAgICB3aGlsZSAodGhpcy5jdXJyZW50VGltZSA8IHRhcmdldFRpbWUpIHtcbiAgICAgIGNvbnN0IG5leHRUaW1lciA9IHRoaXMuZ2V0TmV4dFRpbWVyKCk7XG4gICAgICBpZiAoIW5leHRUaW1lciB8fCBuZXh0VGltZXIuZXhlY3V0ZUF0ID4gdGFyZ2V0VGltZSkge1xuICAgICAgICAvLyBObyBtb3JlIHRpbWVycyB0byBleGVjdXRlIHdpdGhpbiB0aGUgdGltZSByYW5nZVxuICAgICAgICB0aGlzLmN1cnJlbnRUaW1lID0gdGFyZ2V0VGltZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIEV4ZWN1dGUgdGhlIG5leHQgdGltZXJcbiAgICAgIHRoaXMuY3VycmVudFRpbWUgPSBuZXh0VGltZXIuZXhlY3V0ZUF0O1xuICAgICAgdGhpcy5leGVjdXRlVGltZXIobmV4dFRpbWVyKTtcbiAgICB9XG4gIH1cbiAgXG4gIC8qKlxuICAgKiBSdW4gYWxsIHBlbmRpbmcgdGltZXJzXG4gICAqL1xuICBydW5BbGxUaW1lcnMoKTogdm9pZCB7XG4gICAgd2hpbGUgKHRoaXMudGltZXJzLnNpemUgPiAwKSB7XG4gICAgICBjb25zdCBuZXh0VGltZXIgPSB0aGlzLmdldE5leHRUaW1lcigpO1xuICAgICAgaWYgKCFuZXh0VGltZXIpIGJyZWFrO1xuICAgICAgXG4gICAgICB0aGlzLmN1cnJlbnRUaW1lID0gbmV4dFRpbWVyLmV4ZWN1dGVBdDtcbiAgICAgIHRoaXMuZXhlY3V0ZVRpbWVyKG5leHRUaW1lcik7XG4gICAgfVxuICB9XG4gIFxuICAvKipcbiAgICogUnVuIG9ubHkgY3VycmVudGx5IHBlbmRpbmcgdGltZXJzIChub3QgbmV3IG9uZXMgY3JlYXRlZCBkdXJpbmcgZXhlY3V0aW9uKVxuICAgKi9cbiAgcnVuT25seVBlbmRpbmdUaW1lcnMoKTogdm9pZCB7XG4gICAgY29uc3QgcGVuZGluZ1RpbWVycyA9IEFycmF5LmZyb20odGhpcy50aW1lcnMudmFsdWVzKCkpLnNvcnQoXG4gICAgICAoYSwgYikgPT4gYS5leGVjdXRlQXQgLSBiLmV4ZWN1dGVBdFxuICAgICk7XG4gICAgXG4gICAgZm9yIChjb25zdCB0aW1lciBvZiBwZW5kaW5nVGltZXJzKSB7XG4gICAgICBpZiAodGhpcy50aW1lcnMuaGFzKHRpbWVyLmlkKSkgeyAvLyBDaGVjayBpZiBzdGlsbCBhY3RpdmVcbiAgICAgICAgdGhpcy5jdXJyZW50VGltZSA9IHRpbWVyLmV4ZWN1dGVBdDtcbiAgICAgICAgdGhpcy5leGVjdXRlVGltZXIodGltZXIpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBcbiAgLyoqXG4gICAqIEdldCB0aGUgbnVtYmVyIG9mIHBlbmRpbmcgdGltZXJzXG4gICAqL1xuICBnZXRUaW1lckNvdW50KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMudGltZXJzLnNpemU7XG4gIH1cbiAgXG4gIC8vIFByaXZhdGUgaGVscGVyIG1ldGhvZHNcbiAgXG4gIHByaXZhdGUgY3JlYXRlU2V0VGltZW91dCgpIHtcbiAgICByZXR1cm4gKGNhbGxiYWNrOiAoLi4uYXJnczogYW55W10pID0+IHZvaWQsIGRlbGF5OiBudW1iZXIgPSAwLCAuLi5hcmdzOiBhbnlbXSk6IG51bWJlciA9PiB7XG4gICAgICBjb25zdCBpZCA9IHRoaXMudGltZXJJZENvdW50ZXIrKztcbiAgICAgIGNvbnN0IHRhc2s6IFRpbWVyVGFzayA9IHtcbiAgICAgICAgaWQsXG4gICAgICAgIHR5cGU6ICd0aW1lb3V0JyxcbiAgICAgICAgY2FsbGJhY2ssXG4gICAgICAgIGRlbGF5LFxuICAgICAgICBhcmdzLFxuICAgICAgICBzY2hlZHVsZWRBdDogdGhpcy5jdXJyZW50VGltZSxcbiAgICAgICAgZXhlY3V0ZUF0OiB0aGlzLmN1cnJlbnRUaW1lICsgTWF0aC5tYXgoMCwgZGVsYXkpLFxuICAgICAgICBpc0FjdGl2ZTogdHJ1ZVxuICAgICAgfTtcbiAgICAgIFxuICAgICAgdGhpcy50aW1lcnMuc2V0KGlkLCB0YXNrKTtcbiAgICAgIHJldHVybiBpZDtcbiAgICB9O1xuICB9XG4gIFxuICBwcml2YXRlIGNyZWF0ZUNsZWFyVGltZW91dCgpIHtcbiAgICByZXR1cm4gKGlkOiBudW1iZXIpOiB2b2lkID0+IHtcbiAgICAgIHRoaXMudGltZXJzLmRlbGV0ZShpZCk7XG4gICAgfTtcbiAgfVxuICBcbiAgcHJpdmF0ZSBjcmVhdGVTZXRJbnRlcnZhbCgpIHtcbiAgICByZXR1cm4gKGNhbGxiYWNrOiAoLi4uYXJnczogYW55W10pID0+IHZvaWQsIGRlbGF5OiBudW1iZXIgPSAwLCAuLi5hcmdzOiBhbnlbXSk6IG51bWJlciA9PiB7XG4gICAgICBjb25zdCBpZCA9IHRoaXMudGltZXJJZENvdW50ZXIrKztcbiAgICAgIGNvbnN0IHRhc2s6IFRpbWVyVGFzayA9IHtcbiAgICAgICAgaWQsXG4gICAgICAgIHR5cGU6ICdpbnRlcnZhbCcsXG4gICAgICAgIGNhbGxiYWNrLFxuICAgICAgICBkZWxheTogTWF0aC5tYXgoMSwgZGVsYXkpLCAvLyBJbnRlcnZhbHMgbXVzdCBoYXZlIGF0IGxlYXN0IDFtcyBkZWxheVxuICAgICAgICBhcmdzLFxuICAgICAgICBzY2hlZHVsZWRBdDogdGhpcy5jdXJyZW50VGltZSxcbiAgICAgICAgZXhlY3V0ZUF0OiB0aGlzLmN1cnJlbnRUaW1lICsgTWF0aC5tYXgoMSwgZGVsYXkpLFxuICAgICAgICBpc0FjdGl2ZTogdHJ1ZVxuICAgICAgfTtcbiAgICAgIFxuICAgICAgdGhpcy50aW1lcnMuc2V0KGlkLCB0YXNrKTtcbiAgICAgIHJldHVybiBpZDtcbiAgICB9O1xuICB9XG4gIFxuICBwcml2YXRlIGNyZWF0ZUNsZWFySW50ZXJ2YWwoKSB7XG4gICAgcmV0dXJuIChpZDogbnVtYmVyKTogdm9pZCA9PiB7XG4gICAgICB0aGlzLnRpbWVycy5kZWxldGUoaWQpO1xuICAgIH07XG4gIH1cbiAgXG4gIHByaXZhdGUgY3JlYXRlU2V0SW1tZWRpYXRlKCkge1xuICAgIHJldHVybiAoY2FsbGJhY2s6ICguLi5hcmdzOiBhbnlbXSkgPT4gdm9pZCwgLi4uYXJnczogYW55W10pOiBudW1iZXIgPT4ge1xuICAgICAgY29uc3QgaWQgPSB0aGlzLnRpbWVySWRDb3VudGVyKys7XG4gICAgICBjb25zdCB0YXNrOiBUaW1lclRhc2sgPSB7XG4gICAgICAgIGlkLFxuICAgICAgICB0eXBlOiAndGltZW91dCcsXG4gICAgICAgIGNhbGxiYWNrLFxuICAgICAgICBkZWxheTogMCxcbiAgICAgICAgYXJncyxcbiAgICAgICAgc2NoZWR1bGVkQXQ6IHRoaXMuY3VycmVudFRpbWUsXG4gICAgICAgIGV4ZWN1dGVBdDogdGhpcy5jdXJyZW50VGltZSwgLy8gSW1tZWRpYXRlIGV4ZWN1dGlvblxuICAgICAgICBpc0FjdGl2ZTogdHJ1ZVxuICAgICAgfTtcbiAgICAgIFxuICAgICAgdGhpcy50aW1lcnMuc2V0KGlkLCB0YXNrKTtcbiAgICAgIHJldHVybiBpZDtcbiAgICB9O1xuICB9XG4gIFxuICBwcml2YXRlIGNyZWF0ZUNsZWFySW1tZWRpYXRlKCkge1xuICAgIHJldHVybiAoaWQ6IG51bWJlcik6IHZvaWQgPT4ge1xuICAgICAgdGhpcy50aW1lcnMuZGVsZXRlKGlkKTtcbiAgICB9O1xuICB9XG4gIFxuICBwcml2YXRlIGNyZWF0ZUZha2VEYXRlKCkge1xuICAgIGNvbnN0IHN0YXRlID0gdGhpcztcbiAgICBcbiAgICBmdW5jdGlvbiBGYWtlRGF0ZSh0aGlzOiBhbnksIC4uLmFyZ3M6IGFueVtdKSB7XG4gICAgICBpZiAoYXJncy5sZW5ndGggPT09IDApIHtcbiAgICAgICAgcmV0dXJuIG5ldyBzdGF0ZS5vcmlnaW5hbFRpbWVycyEuRGF0ZShzdGF0ZS5jdXJyZW50VGltZSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gbmV3IChzdGF0ZS5vcmlnaW5hbFRpbWVycyEuRGF0ZSBhcyBhbnkpKC4uLmFyZ3MpO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvLyBDb3B5IHN0YXRpYyBtZXRob2RzIGZyb20gcmVhbCBEYXRlXG4gICAgRmFrZURhdGUubm93ID0gKCkgPT4gc3RhdGUuY3VycmVudFRpbWU7XG4gICAgRmFrZURhdGUucGFyc2UgPSBzdGF0ZS5vcmlnaW5hbFRpbWVycyEuRGF0ZS5wYXJzZTtcbiAgICBGYWtlRGF0ZS5VVEMgPSBzdGF0ZS5vcmlnaW5hbFRpbWVycyEuRGF0ZS5VVEM7XG4gICAgRmFrZURhdGUucHJvdG90eXBlID0gc3RhdGUub3JpZ2luYWxUaW1lcnMhLkRhdGUucHJvdG90eXBlO1xuICAgIFxuICAgIHJldHVybiBGYWtlRGF0ZTtcbiAgfVxuICBcbiAgcHJpdmF0ZSBnZXROZXh0VGltZXIoKTogVGltZXJUYXNrIHwgbnVsbCB7XG4gICAgbGV0IG5leHRUaW1lcjogVGltZXJUYXNrIHwgbnVsbCA9IG51bGw7XG4gICAgXG4gICAgZm9yIChjb25zdCB0aW1lciBvZiB0aGlzLnRpbWVycy52YWx1ZXMoKSkge1xuICAgICAgaWYgKHRpbWVyLmlzQWN0aXZlICYmICghbmV4dFRpbWVyIHx8IHRpbWVyLmV4ZWN1dGVBdCA8IG5leHRUaW1lci5leGVjdXRlQXQpKSB7XG4gICAgICAgIG5leHRUaW1lciA9IHRpbWVyO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gbmV4dFRpbWVyO1xuICB9XG4gIFxuICBwcml2YXRlIGV4ZWN1dGVUaW1lcih0aW1lcjogVGltZXJUYXNrKTogdm9pZCB7XG4gICAgaWYgKCF0aW1lci5pc0FjdGl2ZSB8fCAhdGhpcy50aW1lcnMuaGFzKHRpbWVyLmlkKSkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBcbiAgICB0cnkge1xuICAgICAgdGltZXIuY2FsbGJhY2soLi4udGltZXIuYXJncyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIFRpbWVyIGVycm9ycyBzaG91bGQgbm90IHN0b3AgZmFrZSB0aW1lciBleGVjdXRpb25cbiAgICAgIGNvbnNvbGUuZXJyb3IoJ1RpbWVyIGNhbGxiYWNrIGVycm9yOicsIGVycm9yKTtcbiAgICB9XG4gICAgXG4gICAgaWYgKHRpbWVyLnR5cGUgPT09ICd0aW1lb3V0Jykge1xuICAgICAgLy8gUmVtb3ZlIG9uZS10aW1lIHRpbWVyc1xuICAgICAgdGhpcy50aW1lcnMuZGVsZXRlKHRpbWVyLmlkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gUmVzY2hlZHVsZSBpbnRlcnZhbHNcbiAgICAgIHRpbWVyLmV4ZWN1dGVBdCA9IHRoaXMuY3VycmVudFRpbWUgKyB0aW1lci5kZWxheTtcbiAgICB9XG4gIH1cbiAgXG4gIHByaXZhdGUgY2xlYXJBbGxUaW1lcnMoKTogdm9pZCB7XG4gICAgdGhpcy50aW1lcnMuY2xlYXIoKTtcbiAgICB0aGlzLmN1cnJlbnRUaW1lID0gMDtcbiAgICB0aGlzLnRpbWVySWRDb3VudGVyID0gMTtcbiAgfVxufVxuXG4vLyBHbG9iYWwgZmFrZSB0aW1lciBpbnN0YW5jZVxuY29uc3QgZ2xvYmFsRmFrZVRpbWVycyA9IG5ldyBGYWtlVGltZXJTdGF0ZSgpO1xuXG4vLyBQdWJsaWMgQVBJIGZ1bmN0aW9uc1xuZXhwb3J0IGZ1bmN0aW9uIHVzZUZha2VUaW1lcnMoKTogdm9pZCB7XG4gIGdsb2JhbEZha2VUaW1lcnMudXNlRmFrZVRpbWVycygpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gdXNlUmVhbFRpbWVycygpOiB2b2lkIHtcbiAgZ2xvYmFsRmFrZVRpbWVycy51c2VSZWFsVGltZXJzKCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRTeXN0ZW1UaW1lKHRpbWU6IG51bWJlciB8IERhdGUpOiB2b2lkIHtcbiAgZ2xvYmFsRmFrZVRpbWVycy5zZXRTeXN0ZW1UaW1lKHRpbWUpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gYWR2YW5jZVRpbWVyc0J5VGltZShtc1RvUnVuOiBudW1iZXIpOiB2b2lkIHtcbiAgZ2xvYmFsRmFrZVRpbWVycy5hZHZhbmNlVGltZXJzQnlUaW1lKG1zVG9SdW4pO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcnVuQWxsVGltZXJzKCk6IHZvaWQge1xuICBnbG9iYWxGYWtlVGltZXJzLnJ1bkFsbFRpbWVycygpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcnVuT25seVBlbmRpbmdUaW1lcnMoKTogdm9pZCB7XG4gIGdsb2JhbEZha2VUaW1lcnMucnVuT25seVBlbmRpbmdUaW1lcnMoKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGdldFRpbWVyQ291bnQoKTogbnVtYmVyIHtcbiAgcmV0dXJuIGdsb2JhbEZha2VUaW1lcnMuZ2V0VGltZXJDb3VudCgpO1xufVxuXG4vLyBBbGlhcyBmb3IgSmVzdCBjb21wYXRpYmlsaXR5XG5leHBvcnQgY29uc3QgYWR2YW5jZVRpbWVyc1RvTmV4dFRpbWVyID0gcnVuT25seVBlbmRpbmdUaW1lcnM7XG5leHBvcnQgY29uc3QgY2xlYXJBbGxUaW1lcnMgPSB1c2VSZWFsVGltZXJzO1xuXG4vLyBHZXQgY3VycmVudCBmYWtlIHRpbWVcbmV4cG9ydCBmdW5jdGlvbiBub3coKTogbnVtYmVyIHtcbiAgcmV0dXJuIGdsb2JhbEZha2VUaW1lcnMubm93KCk7XG59Il0sInZlcnNpb24iOjN9