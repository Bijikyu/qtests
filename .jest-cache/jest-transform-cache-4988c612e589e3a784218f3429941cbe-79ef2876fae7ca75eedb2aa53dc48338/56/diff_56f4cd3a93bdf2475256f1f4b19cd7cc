04136505302f273266715d0efe41bbaa
"use strict";
/**
 * Diff and Formatting Utilities for Assertions
 *
 * This module provides utilities for deep equality comparison and
 * generating helpful diff outputs for failed assertions.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.deepEqual = deepEqual;
exports.formatValue = formatValue;
exports.generateDiff = generateDiff;
/**
 * Deep equality comparison that handles all JavaScript types
 * Including primitives, objects, arrays, dates, regexes, etc.
 */
function deepEqual(a, b) {
    // Handle same reference
    if (a === b)
        return true;
    // Handle null/undefined
    if (a == null || b == null)
        return a === b;
    // Handle different types
    if (typeof a !== typeof b)
        return false;
    // Handle primitives
    if (typeof a !== 'object')
        return a === b;
    // Handle arrays
    if (Array.isArray(a) !== Array.isArray(b))
        return false;
    if (Array.isArray(a)) {
        if (a.length !== b.length)
            return false;
        for (let i = 0; i < a.length; i++) {
            if (!deepEqual(a[i], b[i]))
                return false;
        }
        return true;
    }
    // Handle dates
    if (a instanceof Date && b instanceof Date) {
        return a.getTime() === b.getTime();
    }
    // Handle regexes
    if (a instanceof RegExp && b instanceof RegExp) {
        return a.toString() === b.toString();
    }
    // Handle objects
    const keysA = Object.keys(a);
    const keysB = Object.keys(b);
    if (keysA.length !== keysB.length)
        return false;
    for (const key of keysA) {
        if (!keysB.includes(key))
            return false;
        if (!deepEqual(a[key], b[key]))
            return false;
    }
    return true;
}
/**
 * Format a value for display in error messages
 */
function formatValue(value) {
    if (value === null)
        return 'null';
    if (value === undefined)
        return 'undefined';
    if (typeof value === 'string')
        return `"${value}"`;
    if (typeof value === 'number')
        return String(value);
    if (typeof value === 'boolean')
        return String(value);
    if (typeof value === 'function')
        return `[Function: ${value.name || 'anonymous'}]`;
    if (value instanceof Date)
        return `Date(${value.toISOString()})`;
    if (value instanceof RegExp)
        return value.toString();
    if (Array.isArray(value)) {
        if (value.length <= 5) {
            return `[${value.map(formatValue).join(', ')}]`;
        }
        else {
            return `[${value.slice(0, 3).map(formatValue).join(', ')}, ... ${value.length - 3} more]`;
        }
    }
    // Handle objects
    try {
        const json = JSON.stringify(value, null, 2);
        if (json.length <= 100)
            return json;
        return `{\n  ${Object.keys(value).slice(0, 3).join(', ')}${Object.keys(value).length > 3 ? ', ...' : ''}\n}`;
    }
    catch {
        return `[Object: ${Object.prototype.toString.call(value)}]`;
    }
}
/**
 * Generate a diff between expected and received values
 * Provides a simple but helpful diff for debugging test failures
 */
function generateDiff(expected, received) {
    const expectedStr = formatValue(expected);
    const receivedStr = formatValue(received);
    // Simple line-by-line diff for multiline strings
    if (typeof expected === 'string' && typeof received === 'string' &&
        (expected.includes('\n') || received.includes('\n'))) {
        const expectedLines = expected.split('\n');
        const receivedLines = received.split('\n');
        const diff = [];
        const maxLines = Math.max(expectedLines.length, receivedLines.length);
        for (let i = 0; i < maxLines; i++) {
            const expectedLine = expectedLines[i];
            const receivedLine = receivedLines[i];
            if (expectedLine === receivedLine) {
                diff.push(`  ${expectedLine || ''}`);
            }
            else {
                if (expectedLine !== undefined) {
                    diff.push(`- ${expectedLine}`);
                }
                if (receivedLine !== undefined) {
                    diff.push(`+ ${receivedLine}`);
                }
            }
        }
        return diff.join('\n');
    }
    // Simple object property diff
    if (typeof expected === 'object' && typeof received === 'object' &&
        expected !== null && received !== null &&
        !Array.isArray(expected) && !Array.isArray(received)) {
        const allKeys = new Set([...Object.keys(expected), ...Object.keys(received)]);
        const diff = [];
        diff.push('Object {');
        for (const key of allKeys) {
            const hasExpected = key in expected;
            const hasReceived = key in received;
            if (hasExpected && hasReceived) {
                if (deepEqual(expected[key], received[key])) {
                    diff.push(`  ${key}: ${formatValue(expected[key])}`);
                }
                else {
                    diff.push(`- ${key}: ${formatValue(expected[key])}`);
                    diff.push(`+ ${key}: ${formatValue(received[key])}`);
                }
            }
            else if (hasExpected) {
                diff.push(`- ${key}: ${formatValue(expected[key])}`);
            }
            else {
                diff.push(`+ ${key}: ${formatValue(received[key])}`);
            }
        }
        diff.push('}');
        return diff.join('\n  ');
    }
    // Default diff format
    return `Expected: ${expectedStr}\nReceived: ${receivedStr}`;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS91dGlscy90ZXN0aW5nL2V4cGVjdC9kaWZmLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7QUFNSCw4QkE2Q0M7QUFLRCxrQ0F5QkM7QUFNRCxvQ0FrRUM7QUF2SkQ7OztHQUdHO0FBQ0gsU0FBZ0IsU0FBUyxDQUFDLENBQU0sRUFBRSxDQUFNO0lBQ3RDLHdCQUF3QjtJQUN4QixJQUFJLENBQUMsS0FBSyxDQUFDO1FBQUUsT0FBTyxJQUFJLENBQUM7SUFFekIsd0JBQXdCO0lBQ3hCLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksSUFBSTtRQUFFLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUUzQyx5QkFBeUI7SUFDekIsSUFBSSxPQUFPLENBQUMsS0FBSyxPQUFPLENBQUM7UUFBRSxPQUFPLEtBQUssQ0FBQztJQUV4QyxvQkFBb0I7SUFDcEIsSUFBSSxPQUFPLENBQUMsS0FBSyxRQUFRO1FBQUUsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBRTFDLGdCQUFnQjtJQUNoQixJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssS0FBSyxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUM7UUFBRSxPQUFPLEtBQUssQ0FBQztJQUN4RCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUNyQixJQUFJLENBQUMsQ0FBQyxNQUFNLEtBQUssQ0FBQyxDQUFDLE1BQU07WUFBRSxPQUFPLEtBQUssQ0FBQztRQUN4QyxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQ2xDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFBRSxPQUFPLEtBQUssQ0FBQztRQUMzQyxDQUFDO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQsZUFBZTtJQUNmLElBQUksQ0FBQyxZQUFZLElBQUksSUFBSSxDQUFDLFlBQVksSUFBSSxFQUFFLENBQUM7UUFDM0MsT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEtBQUssQ0FBQyxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFFRCxpQkFBaUI7SUFDakIsSUFBSSxDQUFDLFlBQVksTUFBTSxJQUFJLENBQUMsWUFBWSxNQUFNLEVBQUUsQ0FBQztRQUMvQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEVBQUUsS0FBSyxDQUFDLENBQUMsUUFBUSxFQUFFLENBQUM7SUFDdkMsQ0FBQztJQUVELGlCQUFpQjtJQUNqQixNQUFNLEtBQUssR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQzdCLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFN0IsSUFBSSxLQUFLLENBQUMsTUFBTSxLQUFLLEtBQUssQ0FBQyxNQUFNO1FBQUUsT0FBTyxLQUFLLENBQUM7SUFFaEQsS0FBSyxNQUFNLEdBQUcsSUFBSSxLQUFLLEVBQUUsQ0FBQztRQUN4QixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUM7WUFBRSxPQUFPLEtBQUssQ0FBQztRQUN2QyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUM7WUFBRSxPQUFPLEtBQUssQ0FBQztJQUMvQyxDQUFDO0lBRUQsT0FBTyxJQUFJLENBQUM7QUFDZCxDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFnQixXQUFXLENBQUMsS0FBVTtJQUNwQyxJQUFJLEtBQUssS0FBSyxJQUFJO1FBQUUsT0FBTyxNQUFNLENBQUM7SUFDbEMsSUFBSSxLQUFLLEtBQUssU0FBUztRQUFFLE9BQU8sV0FBVyxDQUFDO0lBQzVDLElBQUksT0FBTyxLQUFLLEtBQUssUUFBUTtRQUFFLE9BQU8sSUFBSSxLQUFLLEdBQUcsQ0FBQztJQUNuRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVE7UUFBRSxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNwRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFNBQVM7UUFBRSxPQUFPLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNyRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFVBQVU7UUFBRSxPQUFPLGNBQWMsS0FBSyxDQUFDLElBQUksSUFBSSxXQUFXLEdBQUcsQ0FBQztJQUNuRixJQUFJLEtBQUssWUFBWSxJQUFJO1FBQUUsT0FBTyxRQUFRLEtBQUssQ0FBQyxXQUFXLEVBQUUsR0FBRyxDQUFDO0lBQ2pFLElBQUksS0FBSyxZQUFZLE1BQU07UUFBRSxPQUFPLEtBQUssQ0FBQyxRQUFRLEVBQUUsQ0FBQztJQUNyRCxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQztRQUN6QixJQUFJLEtBQUssQ0FBQyxNQUFNLElBQUksQ0FBQyxFQUFFLENBQUM7WUFDdEIsT0FBTyxJQUFJLEtBQUssQ0FBQyxHQUFHLENBQUMsV0FBVyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUM7UUFDbEQsQ0FBQzthQUFNLENBQUM7WUFDTixPQUFPLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxLQUFLLENBQUMsTUFBTSxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQzVGLENBQUM7SUFDSCxDQUFDO0lBRUQsaUJBQWlCO0lBQ2pCLElBQUksQ0FBQztRQUNILE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsQ0FBQztRQUM1QyxJQUFJLElBQUksQ0FBQyxNQUFNLElBQUksR0FBRztZQUFFLE9BQU8sSUFBSSxDQUFDO1FBQ3BDLE9BQU8sUUFBUSxNQUFNLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQztJQUMvRyxDQUFDO0lBQUMsTUFBTSxDQUFDO1FBQ1AsT0FBTyxZQUFZLE1BQU0sQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDO0lBQzlELENBQUM7QUFDSCxDQUFDO0FBRUQ7OztHQUdHO0FBQ0gsU0FBZ0IsWUFBWSxDQUFDLFFBQWEsRUFBRSxRQUFhO0lBQ3ZELE1BQU0sV0FBVyxHQUFHLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMxQyxNQUFNLFdBQVcsR0FBRyxXQUFXLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFMUMsaURBQWlEO0lBQ2pELElBQUksT0FBTyxRQUFRLEtBQUssUUFBUSxJQUFJLE9BQU8sUUFBUSxLQUFLLFFBQVE7UUFDNUQsQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLFFBQVEsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDO1FBQ3pELE1BQU0sYUFBYSxHQUFHLFFBQVEsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDM0MsTUFBTSxhQUFhLEdBQUcsUUFBUSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUUzQyxNQUFNLElBQUksR0FBYSxFQUFFLENBQUM7UUFDMUIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxhQUFhLENBQUMsTUFBTSxFQUFFLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUV0RSxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsUUFBUSxFQUFFLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDbEMsTUFBTSxZQUFZLEdBQUcsYUFBYSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3RDLE1BQU0sWUFBWSxHQUFHLGFBQWEsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUV0QyxJQUFJLFlBQVksS0FBSyxZQUFZLEVBQUUsQ0FBQztnQkFDbEMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLFlBQVksSUFBSSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZDLENBQUM7aUJBQU0sQ0FBQztnQkFDTixJQUFJLFlBQVksS0FBSyxTQUFTLEVBQUUsQ0FBQztvQkFDL0IsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLFlBQVksRUFBRSxDQUFDLENBQUM7Z0JBQ2pDLENBQUM7Z0JBQ0QsSUFBSSxZQUFZLEtBQUssU0FBUyxFQUFFLENBQUM7b0JBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxZQUFZLEVBQUUsQ0FBQyxDQUFDO2dCQUNqQyxDQUFDO1lBQ0gsQ0FBQztRQUNILENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7SUFDekIsQ0FBQztJQUVELDhCQUE4QjtJQUM5QixJQUFJLE9BQU8sUUFBUSxLQUFLLFFBQVEsSUFBSSxPQUFPLFFBQVEsS0FBSyxRQUFRO1FBQzVELFFBQVEsS0FBSyxJQUFJLElBQUksUUFBUSxLQUFLLElBQUk7UUFDdEMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDO1FBRXpELE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxDQUFDLENBQUMsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxFQUFFLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDOUUsTUFBTSxJQUFJLEdBQWEsRUFBRSxDQUFDO1FBRTFCLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7UUFFdEIsS0FBSyxNQUFNLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztZQUMxQixNQUFNLFdBQVcsR0FBRyxHQUFHLElBQUksUUFBUSxDQUFDO1lBQ3BDLE1BQU0sV0FBVyxHQUFHLEdBQUcsSUFBSSxRQUFRLENBQUM7WUFFcEMsSUFBSSxXQUFXLElBQUksV0FBVyxFQUFFLENBQUM7Z0JBQy9CLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsRUFBRSxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDO29CQUM1QyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLFdBQVcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7Z0JBQ3ZELENBQUM7cUJBQU0sQ0FBQztvQkFDTixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLFdBQVcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7b0JBQ3JELElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssV0FBVyxDQUFDLFFBQVEsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQztnQkFDdkQsQ0FBQztZQUNILENBQUM7aUJBQU0sSUFBSSxXQUFXLEVBQUUsQ0FBQztnQkFDdkIsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUcsS0FBSyxXQUFXLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQ3ZELENBQUM7aUJBQU0sQ0FBQztnQkFDTixJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLFdBQVcsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUM7WUFDdkQsQ0FBQztRQUNILENBQUM7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2YsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQzNCLENBQUM7SUFFRCxzQkFBc0I7SUFDdEIsT0FBTyxhQUFhLFdBQVcsZUFBZSxXQUFXLEVBQUUsQ0FBQztBQUM5RCxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9ob21lL3J1bm5lci93b3Jrc3BhY2UvdXRpbHMvdGVzdGluZy9leHBlY3QvZGlmZi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIERpZmYgYW5kIEZvcm1hdHRpbmcgVXRpbGl0aWVzIGZvciBBc3NlcnRpb25zXG4gKiBcbiAqIFRoaXMgbW9kdWxlIHByb3ZpZGVzIHV0aWxpdGllcyBmb3IgZGVlcCBlcXVhbGl0eSBjb21wYXJpc29uIGFuZFxuICogZ2VuZXJhdGluZyBoZWxwZnVsIGRpZmYgb3V0cHV0cyBmb3IgZmFpbGVkIGFzc2VydGlvbnMuXG4gKi9cblxuLyoqXG4gKiBEZWVwIGVxdWFsaXR5IGNvbXBhcmlzb24gdGhhdCBoYW5kbGVzIGFsbCBKYXZhU2NyaXB0IHR5cGVzXG4gKiBJbmNsdWRpbmcgcHJpbWl0aXZlcywgb2JqZWN0cywgYXJyYXlzLCBkYXRlcywgcmVnZXhlcywgZXRjLlxuICovXG5leHBvcnQgZnVuY3Rpb24gZGVlcEVxdWFsKGE6IGFueSwgYjogYW55KTogYm9vbGVhbiB7XG4gIC8vIEhhbmRsZSBzYW1lIHJlZmVyZW5jZVxuICBpZiAoYSA9PT0gYikgcmV0dXJuIHRydWU7XG4gIFxuICAvLyBIYW5kbGUgbnVsbC91bmRlZmluZWRcbiAgaWYgKGEgPT0gbnVsbCB8fCBiID09IG51bGwpIHJldHVybiBhID09PSBiO1xuICBcbiAgLy8gSGFuZGxlIGRpZmZlcmVudCB0eXBlc1xuICBpZiAodHlwZW9mIGEgIT09IHR5cGVvZiBiKSByZXR1cm4gZmFsc2U7XG4gIFxuICAvLyBIYW5kbGUgcHJpbWl0aXZlc1xuICBpZiAodHlwZW9mIGEgIT09ICdvYmplY3QnKSByZXR1cm4gYSA9PT0gYjtcbiAgXG4gIC8vIEhhbmRsZSBhcnJheXNcbiAgaWYgKEFycmF5LmlzQXJyYXkoYSkgIT09IEFycmF5LmlzQXJyYXkoYikpIHJldHVybiBmYWxzZTtcbiAgaWYgKEFycmF5LmlzQXJyYXkoYSkpIHtcbiAgICBpZiAoYS5sZW5ndGggIT09IGIubGVuZ3RoKSByZXR1cm4gZmFsc2U7XG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhLmxlbmd0aDsgaSsrKSB7XG4gICAgICBpZiAoIWRlZXBFcXVhbChhW2ldLCBiW2ldKSkgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICBcbiAgLy8gSGFuZGxlIGRhdGVzXG4gIGlmIChhIGluc3RhbmNlb2YgRGF0ZSAmJiBiIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgIHJldHVybiBhLmdldFRpbWUoKSA9PT0gYi5nZXRUaW1lKCk7XG4gIH1cbiAgXG4gIC8vIEhhbmRsZSByZWdleGVzXG4gIGlmIChhIGluc3RhbmNlb2YgUmVnRXhwICYmIGIgaW5zdGFuY2VvZiBSZWdFeHApIHtcbiAgICByZXR1cm4gYS50b1N0cmluZygpID09PSBiLnRvU3RyaW5nKCk7XG4gIH1cbiAgXG4gIC8vIEhhbmRsZSBvYmplY3RzXG4gIGNvbnN0IGtleXNBID0gT2JqZWN0LmtleXMoYSk7XG4gIGNvbnN0IGtleXNCID0gT2JqZWN0LmtleXMoYik7XG4gIFxuICBpZiAoa2V5c0EubGVuZ3RoICE9PSBrZXlzQi5sZW5ndGgpIHJldHVybiBmYWxzZTtcbiAgXG4gIGZvciAoY29uc3Qga2V5IG9mIGtleXNBKSB7XG4gICAgaWYgKCFrZXlzQi5pbmNsdWRlcyhrZXkpKSByZXR1cm4gZmFsc2U7XG4gICAgaWYgKCFkZWVwRXF1YWwoYVtrZXldLCBiW2tleV0pKSByZXR1cm4gZmFsc2U7XG4gIH1cbiAgXG4gIHJldHVybiB0cnVlO1xufVxuXG4vKipcbiAqIEZvcm1hdCBhIHZhbHVlIGZvciBkaXNwbGF5IGluIGVycm9yIG1lc3NhZ2VzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBmb3JtYXRWYWx1ZSh2YWx1ZTogYW55KTogc3RyaW5nIHtcbiAgaWYgKHZhbHVlID09PSBudWxsKSByZXR1cm4gJ251bGwnO1xuICBpZiAodmFsdWUgPT09IHVuZGVmaW5lZCkgcmV0dXJuICd1bmRlZmluZWQnO1xuICBpZiAodHlwZW9mIHZhbHVlID09PSAnc3RyaW5nJykgcmV0dXJuIGBcIiR7dmFsdWV9XCJgO1xuICBpZiAodHlwZW9mIHZhbHVlID09PSAnbnVtYmVyJykgcmV0dXJuIFN0cmluZyh2YWx1ZSk7XG4gIGlmICh0eXBlb2YgdmFsdWUgPT09ICdib29sZWFuJykgcmV0dXJuIFN0cmluZyh2YWx1ZSk7XG4gIGlmICh0eXBlb2YgdmFsdWUgPT09ICdmdW5jdGlvbicpIHJldHVybiBgW0Z1bmN0aW9uOiAke3ZhbHVlLm5hbWUgfHwgJ2Fub255bW91cyd9XWA7XG4gIGlmICh2YWx1ZSBpbnN0YW5jZW9mIERhdGUpIHJldHVybiBgRGF0ZSgke3ZhbHVlLnRvSVNPU3RyaW5nKCl9KWA7XG4gIGlmICh2YWx1ZSBpbnN0YW5jZW9mIFJlZ0V4cCkgcmV0dXJuIHZhbHVlLnRvU3RyaW5nKCk7XG4gIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgIGlmICh2YWx1ZS5sZW5ndGggPD0gNSkge1xuICAgICAgcmV0dXJuIGBbJHt2YWx1ZS5tYXAoZm9ybWF0VmFsdWUpLmpvaW4oJywgJyl9XWA7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBgWyR7dmFsdWUuc2xpY2UoMCwgMykubWFwKGZvcm1hdFZhbHVlKS5qb2luKCcsICcpfSwgLi4uICR7dmFsdWUubGVuZ3RoIC0gM30gbW9yZV1gO1xuICAgIH1cbiAgfVxuICBcbiAgLy8gSGFuZGxlIG9iamVjdHNcbiAgdHJ5IHtcbiAgICBjb25zdCBqc29uID0gSlNPTi5zdHJpbmdpZnkodmFsdWUsIG51bGwsIDIpO1xuICAgIGlmIChqc29uLmxlbmd0aCA8PSAxMDApIHJldHVybiBqc29uO1xuICAgIHJldHVybiBge1xcbiAgJHtPYmplY3Qua2V5cyh2YWx1ZSkuc2xpY2UoMCwgMykuam9pbignLCAnKX0ke09iamVjdC5rZXlzKHZhbHVlKS5sZW5ndGggPiAzID8gJywgLi4uJyA6ICcnfVxcbn1gO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gYFtPYmplY3Q6ICR7T2JqZWN0LnByb3RvdHlwZS50b1N0cmluZy5jYWxsKHZhbHVlKX1dYDtcbiAgfVxufVxuXG4vKipcbiAqIEdlbmVyYXRlIGEgZGlmZiBiZXR3ZWVuIGV4cGVjdGVkIGFuZCByZWNlaXZlZCB2YWx1ZXNcbiAqIFByb3ZpZGVzIGEgc2ltcGxlIGJ1dCBoZWxwZnVsIGRpZmYgZm9yIGRlYnVnZ2luZyB0ZXN0IGZhaWx1cmVzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBnZW5lcmF0ZURpZmYoZXhwZWN0ZWQ6IGFueSwgcmVjZWl2ZWQ6IGFueSk6IHN0cmluZyB7XG4gIGNvbnN0IGV4cGVjdGVkU3RyID0gZm9ybWF0VmFsdWUoZXhwZWN0ZWQpO1xuICBjb25zdCByZWNlaXZlZFN0ciA9IGZvcm1hdFZhbHVlKHJlY2VpdmVkKTtcbiAgXG4gIC8vIFNpbXBsZSBsaW5lLWJ5LWxpbmUgZGlmZiBmb3IgbXVsdGlsaW5lIHN0cmluZ3NcbiAgaWYgKHR5cGVvZiBleHBlY3RlZCA9PT0gJ3N0cmluZycgJiYgdHlwZW9mIHJlY2VpdmVkID09PSAnc3RyaW5nJyAmJiBcbiAgICAgIChleHBlY3RlZC5pbmNsdWRlcygnXFxuJykgfHwgcmVjZWl2ZWQuaW5jbHVkZXMoJ1xcbicpKSkge1xuICAgIGNvbnN0IGV4cGVjdGVkTGluZXMgPSBleHBlY3RlZC5zcGxpdCgnXFxuJyk7XG4gICAgY29uc3QgcmVjZWl2ZWRMaW5lcyA9IHJlY2VpdmVkLnNwbGl0KCdcXG4nKTtcbiAgICBcbiAgICBjb25zdCBkaWZmOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IG1heExpbmVzID0gTWF0aC5tYXgoZXhwZWN0ZWRMaW5lcy5sZW5ndGgsIHJlY2VpdmVkTGluZXMubGVuZ3RoKTtcbiAgICBcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IG1heExpbmVzOyBpKyspIHtcbiAgICAgIGNvbnN0IGV4cGVjdGVkTGluZSA9IGV4cGVjdGVkTGluZXNbaV07XG4gICAgICBjb25zdCByZWNlaXZlZExpbmUgPSByZWNlaXZlZExpbmVzW2ldO1xuICAgICAgXG4gICAgICBpZiAoZXhwZWN0ZWRMaW5lID09PSByZWNlaXZlZExpbmUpIHtcbiAgICAgICAgZGlmZi5wdXNoKGAgICR7ZXhwZWN0ZWRMaW5lIHx8ICcnfWApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKGV4cGVjdGVkTGluZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgZGlmZi5wdXNoKGAtICR7ZXhwZWN0ZWRMaW5lfWApO1xuICAgICAgICB9XG4gICAgICAgIGlmIChyZWNlaXZlZExpbmUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIGRpZmYucHVzaChgKyAke3JlY2VpdmVkTGluZX1gKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gZGlmZi5qb2luKCdcXG4nKTtcbiAgfVxuICBcbiAgLy8gU2ltcGxlIG9iamVjdCBwcm9wZXJ0eSBkaWZmXG4gIGlmICh0eXBlb2YgZXhwZWN0ZWQgPT09ICdvYmplY3QnICYmIHR5cGVvZiByZWNlaXZlZCA9PT0gJ29iamVjdCcgJiYgXG4gICAgICBleHBlY3RlZCAhPT0gbnVsbCAmJiByZWNlaXZlZCAhPT0gbnVsbCAmJiBcbiAgICAgICFBcnJheS5pc0FycmF5KGV4cGVjdGVkKSAmJiAhQXJyYXkuaXNBcnJheShyZWNlaXZlZCkpIHtcbiAgICBcbiAgICBjb25zdCBhbGxLZXlzID0gbmV3IFNldChbLi4uT2JqZWN0LmtleXMoZXhwZWN0ZWQpLCAuLi5PYmplY3Qua2V5cyhyZWNlaXZlZCldKTtcbiAgICBjb25zdCBkaWZmOiBzdHJpbmdbXSA9IFtdO1xuICAgIFxuICAgIGRpZmYucHVzaCgnT2JqZWN0IHsnKTtcbiAgICBcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBhbGxLZXlzKSB7XG4gICAgICBjb25zdCBoYXNFeHBlY3RlZCA9IGtleSBpbiBleHBlY3RlZDtcbiAgICAgIGNvbnN0IGhhc1JlY2VpdmVkID0ga2V5IGluIHJlY2VpdmVkO1xuICAgICAgXG4gICAgICBpZiAoaGFzRXhwZWN0ZWQgJiYgaGFzUmVjZWl2ZWQpIHtcbiAgICAgICAgaWYgKGRlZXBFcXVhbChleHBlY3RlZFtrZXldLCByZWNlaXZlZFtrZXldKSkge1xuICAgICAgICAgIGRpZmYucHVzaChgICAke2tleX06ICR7Zm9ybWF0VmFsdWUoZXhwZWN0ZWRba2V5XSl9YCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgZGlmZi5wdXNoKGAtICR7a2V5fTogJHtmb3JtYXRWYWx1ZShleHBlY3RlZFtrZXldKX1gKTtcbiAgICAgICAgICBkaWZmLnB1c2goYCsgJHtrZXl9OiAke2Zvcm1hdFZhbHVlKHJlY2VpdmVkW2tleV0pfWApO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGhhc0V4cGVjdGVkKSB7XG4gICAgICAgIGRpZmYucHVzaChgLSAke2tleX06ICR7Zm9ybWF0VmFsdWUoZXhwZWN0ZWRba2V5XSl9YCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBkaWZmLnB1c2goYCsgJHtrZXl9OiAke2Zvcm1hdFZhbHVlKHJlY2VpdmVkW2tleV0pfWApO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBkaWZmLnB1c2goJ30nKTtcbiAgICByZXR1cm4gZGlmZi5qb2luKCdcXG4gICcpO1xuICB9XG4gIFxuICAvLyBEZWZhdWx0IGRpZmYgZm9ybWF0XG4gIHJldHVybiBgRXhwZWN0ZWQ6ICR7ZXhwZWN0ZWRTdHJ9XFxuUmVjZWl2ZWQ6ICR7cmVjZWl2ZWRTdHJ9YDtcbn0iXSwidmVyc2lvbiI6M30=