c5a527f8e91525d6612a081c5d5404c9
/**
 * Test Data Factory for Creating Realistic Test Entities
 * 
 * This class focuses solely on test data creation and management.
 * It eliminates duplicate test data creation across test files.
 */

const {
  logStart,
  logReturn
} = require('../../lib/logUtils');

/**
 * Test Data Factory for Creating Realistic Test Entities
 * 
 * This class eliminates duplicate test data creation across test files
 * by providing standardized factory methods for common test entities.
 */
class TestDataFactory {
  static counter = 0;

  /**
   * Gets next unique counter value for test data
   * 
   * @returns {number} Incremented counter value
   */
  static nextId() {
    return ++this.counter;
  }

  /**
   * Creates a test user with realistic properties
   * 
   * @param {Object} overrides - Properties to override defaults
   * @returns {Object} Test user object
   */
  static createUser(overrides = {}) {
    logStart('TestDataFactory.createUser', overrides);
    const id = this.nextId();
    const user = {
      id: `user-${id}`,
      username: `testuser${id}`,
      email: `test${id}@example.com`,
      password: `hashedpassword${id}`,
      firstName: 'Test',
      lastName: `User${id}`,
      isActive: true,
      createdAt: new Date(),
      updatedAt: new Date(),
      ...overrides
    };
    logReturn('TestDataFactory.createUser', user);
    return user;
  }

  /**
   * Creates a test API key with realistic properties
   * 
   * @param {Object} overrides - Properties to override defaults
   * @returns {Object} Test API key object
   */
  static createApiKey(overrides = {}) {
    logStart('TestDataFactory.createApiKey', overrides);
    const id = this.nextId();
    const apiKey = {
      id: `key-${id}`,
      key: `test-api-key-${id}-${Math.random().toString(36).substr(2, 9)}`,
      name: `Test API Key ${id}`,
      userId: `user-${id}`,
      isActive: true,
      permissions: ['read', 'write'],
      createdAt: new Date(),
      expiresAt: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000),
      // 30 days
      ...overrides
    };
    logReturn('TestDataFactory.createApiKey', apiKey);
    return apiKey;
  }

  /**
   * Creates a test log entry with realistic properties
   * 
   * @param {Object} overrides - Properties to override defaults
   * @returns {Object} Test log entry object
   */
  static createLogEntry(overrides = {}) {
    logStart('TestDataFactory.createLogEntry', overrides);
    const id = this.nextId();
    const logEntry = {
      id: `log-${id}`,
      message: `Test log message ${id}`,
      level: 'info',
      timestamp: new Date(),
      userId: `user-${id}`,
      source: 'test-application',
      metadata: {
        testId: id,
        environment: 'test'
      },
      ...overrides
    };
    logReturn('TestDataFactory.createLogEntry', logEntry);
    return logEntry;
  }

  /**
   * Creates a test configuration object with realistic properties
   * 
   * @param {Object} overrides - Properties to override defaults
   * @returns {Object} Test configuration object
   */
  static createConfig(overrides = {}) {
    logStart('TestDataFactory.createConfig', overrides);
    const id = this.nextId();
    const config = {
      id: `config-${id}`,
      name: `Test Configuration ${id}`,
      value: `test-value-${id}`,
      environment: 'test',
      type: 'string',
      isActive: true,
      createdAt: new Date(),
      updatedAt: new Date(),
      ...overrides
    };
    logReturn('TestDataFactory.createConfig', config);
    return config;
  }

  /**
   * Creates multiple test entities using a factory function
   * 
   * @param {Function} factoryFn - Factory function to create single entities
   * @param {number} count - Number of entities to create
   * @param {Object} baseOverrides - Base overrides applied to all entities
   * @returns {Array} Array of created test entities
   */
  static createMultiple(factoryFn, count = 10, baseOverrides = {}) {
    logStart('TestDataFactory.createMultiple', {
      count,
      baseOverrides
    });
    const entities = [];
    for (let i = 0; i < count; i++) {
      const entityOverrides = {
        ...baseOverrides
      };
      entities.push(factoryFn.call(this, entityOverrides));
    }
    logReturn('TestDataFactory.createMultiple', `${entities.length} entities`);
    return entities;
  }

  // Instance method wrappers for compatibility with TestSuiteBuilder
  createUser(overrides) {
    return TestDataFactory.createUser(overrides);
  }
  createApiKey(overrides) {
    return TestDataFactory.createApiKey(overrides);
  }
  createLogEntry(overrides) {
    return TestDataFactory.createLogEntry(overrides);
  }
  createConfig(overrides) {
    return TestDataFactory.createConfig(overrides);
  }
  createMultiple(factoryFn, count, baseOverrides) {
    return TestDataFactory.createMultiple(factoryFn.bind(this), count, baseOverrides);
  }

  // Static method for resetting counter
  static reset() {
    this.counter = 0;
  }

  /**
   * Creates related entities with relationships
   * 
   * @param {Object} config - Configuration for creating related entities
   * @returns {Object} Object with created entities and relationships
   */
  static createRelatedEntities(config) {
    logStart('TestDataFactory.createRelatedEntities', config);
    try {
      const {
        userCount = 1,
        apiKeysPerUser = 1,
        logsPerUser = 1
      } = config;
      const users = [];
      const apiKeys = [];
      const logs = [];

      // Create users first
      for (let i = 0; i < userCount; i++) {
        users.push(this.createUser());
      }

      // Create API keys for each user
      users.forEach(user => {
        for (let i = 0; i < apiKeysPerUser; i++) {
          apiKeys.push(this.createApiKey({
            userId: user.id,
            key: `${user.username}-key-${i + 1}`
          }));
        }
      });

      // Create logs for each user
      users.forEach(user => {
        for (let i = 0; i < logsPerUser; i++) {
          logs.push(this.createLogEntry({
            userId: user.id,
            endpoint: `/api/users/${user.id}/data-${i + 1}`
          }));
        }
      });
      const result = {
        users,
        apiKeys,
        logs,
        relationships: {
          userToApiKeys: users.reduce((acc, user) => {
            acc[user.id] = apiKeys.filter(key => key.userId === user.id);
            return acc;
          }, {}),
          userToLogs: users.reduce((acc, user) => {
            acc[user.id] = logs.filter(log => log.userId === user.id);
            return acc;
          }, {})
        }
      };
      logReturn('TestDataFactory.createRelatedEntities', `created ${users.length} users, ${apiKeys.length} API keys, ${logs.length} logs`);
      return result;
    } catch (error) {
      logReturn('TestDataFactory.createRelatedEntities', `error: ${error.message}`);
      throw error;
    }
  }
}
module.exports = {
  TestDataFactory
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJsb2dTdGFydCIsImxvZ1JldHVybiIsInJlcXVpcmUiLCJUZXN0RGF0YUZhY3RvcnkiLCJjb3VudGVyIiwibmV4dElkIiwiY3JlYXRlVXNlciIsIm92ZXJyaWRlcyIsImlkIiwidXNlciIsInVzZXJuYW1lIiwiZW1haWwiLCJwYXNzd29yZCIsImZpcnN0TmFtZSIsImxhc3ROYW1lIiwiaXNBY3RpdmUiLCJjcmVhdGVkQXQiLCJEYXRlIiwidXBkYXRlZEF0IiwiY3JlYXRlQXBpS2V5IiwiYXBpS2V5Iiwia2V5IiwiTWF0aCIsInJhbmRvbSIsInRvU3RyaW5nIiwic3Vic3RyIiwibmFtZSIsInVzZXJJZCIsInBlcm1pc3Npb25zIiwiZXhwaXJlc0F0Iiwibm93IiwiY3JlYXRlTG9nRW50cnkiLCJsb2dFbnRyeSIsIm1lc3NhZ2UiLCJsZXZlbCIsInRpbWVzdGFtcCIsInNvdXJjZSIsIm1ldGFkYXRhIiwidGVzdElkIiwiZW52aXJvbm1lbnQiLCJjcmVhdGVDb25maWciLCJjb25maWciLCJ2YWx1ZSIsInR5cGUiLCJjcmVhdGVNdWx0aXBsZSIsImZhY3RvcnlGbiIsImNvdW50IiwiYmFzZU92ZXJyaWRlcyIsImVudGl0aWVzIiwiaSIsImVudGl0eU92ZXJyaWRlcyIsInB1c2giLCJjYWxsIiwibGVuZ3RoIiwiYmluZCIsInJlc2V0IiwiY3JlYXRlUmVsYXRlZEVudGl0aWVzIiwidXNlckNvdW50IiwiYXBpS2V5c1BlclVzZXIiLCJsb2dzUGVyVXNlciIsInVzZXJzIiwiYXBpS2V5cyIsImxvZ3MiLCJmb3JFYWNoIiwiZW5kcG9pbnQiLCJyZXN1bHQiLCJyZWxhdGlvbnNoaXBzIiwidXNlclRvQXBpS2V5cyIsInJlZHVjZSIsImFjYyIsImZpbHRlciIsInVzZXJUb0xvZ3MiLCJsb2ciLCJlcnJvciIsIm1vZHVsZSIsImV4cG9ydHMiXSwic291cmNlcyI6WyJ0ZXN0RGF0YUZhY3RvcnkuanMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBUZXN0IERhdGEgRmFjdG9yeSBmb3IgQ3JlYXRpbmcgUmVhbGlzdGljIFRlc3QgRW50aXRpZXNcbiAqIFxuICogVGhpcyBjbGFzcyBmb2N1c2VzIHNvbGVseSBvbiB0ZXN0IGRhdGEgY3JlYXRpb24gYW5kIG1hbmFnZW1lbnQuXG4gKiBJdCBlbGltaW5hdGVzIGR1cGxpY2F0ZSB0ZXN0IGRhdGEgY3JlYXRpb24gYWNyb3NzIHRlc3QgZmlsZXMuXG4gKi9cblxuY29uc3QgeyBsb2dTdGFydCwgbG9nUmV0dXJuIH0gPSByZXF1aXJlKCcuLi8uLi9saWIvbG9nVXRpbHMnKTtcblxuLyoqXG4gKiBUZXN0IERhdGEgRmFjdG9yeSBmb3IgQ3JlYXRpbmcgUmVhbGlzdGljIFRlc3QgRW50aXRpZXNcbiAqIFxuICogVGhpcyBjbGFzcyBlbGltaW5hdGVzIGR1cGxpY2F0ZSB0ZXN0IGRhdGEgY3JlYXRpb24gYWNyb3NzIHRlc3QgZmlsZXNcbiAqIGJ5IHByb3ZpZGluZyBzdGFuZGFyZGl6ZWQgZmFjdG9yeSBtZXRob2RzIGZvciBjb21tb24gdGVzdCBlbnRpdGllcy5cbiAqL1xuY2xhc3MgVGVzdERhdGFGYWN0b3J5IHtcbiAgc3RhdGljIGNvdW50ZXIgPSAwO1xuXG4gIC8qKlxuICAgKiBHZXRzIG5leHQgdW5pcXVlIGNvdW50ZXIgdmFsdWUgZm9yIHRlc3QgZGF0YVxuICAgKiBcbiAgICogQHJldHVybnMge251bWJlcn0gSW5jcmVtZW50ZWQgY291bnRlciB2YWx1ZVxuICAgKi9cbiAgc3RhdGljIG5leHRJZCgpIHtcbiAgICByZXR1cm4gKyt0aGlzLmNvdW50ZXI7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBhIHRlc3QgdXNlciB3aXRoIHJlYWxpc3RpYyBwcm9wZXJ0aWVzXG4gICAqIFxuICAgKiBAcGFyYW0ge09iamVjdH0gb3ZlcnJpZGVzIC0gUHJvcGVydGllcyB0byBvdmVycmlkZSBkZWZhdWx0c1xuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBUZXN0IHVzZXIgb2JqZWN0XG4gICAqL1xuICBzdGF0aWMgY3JlYXRlVXNlcihvdmVycmlkZXMgPSB7fSkge1xuICAgIGxvZ1N0YXJ0KCdUZXN0RGF0YUZhY3RvcnkuY3JlYXRlVXNlcicsIG92ZXJyaWRlcyk7XG4gICAgXG4gICAgY29uc3QgaWQgPSB0aGlzLm5leHRJZCgpO1xuICAgIGNvbnN0IHVzZXIgPSB7XG4gICAgICBpZDogYHVzZXItJHtpZH1gLFxuICAgICAgdXNlcm5hbWU6IGB0ZXN0dXNlciR7aWR9YCxcbiAgICAgIGVtYWlsOiBgdGVzdCR7aWR9QGV4YW1wbGUuY29tYCxcbiAgICAgIHBhc3N3b3JkOiBgaGFzaGVkcGFzc3dvcmQke2lkfWAsXG4gICAgICBmaXJzdE5hbWU6ICdUZXN0JyxcbiAgICAgIGxhc3ROYW1lOiBgVXNlciR7aWR9YCxcbiAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgLi4ub3ZlcnJpZGVzXG4gICAgfTtcbiAgICBcbiAgICBsb2dSZXR1cm4oJ1Rlc3REYXRhRmFjdG9yeS5jcmVhdGVVc2VyJywgdXNlcik7XG4gICAgcmV0dXJuIHVzZXI7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBhIHRlc3QgQVBJIGtleSB3aXRoIHJlYWxpc3RpYyBwcm9wZXJ0aWVzXG4gICAqIFxuICAgKiBAcGFyYW0ge09iamVjdH0gb3ZlcnJpZGVzIC0gUHJvcGVydGllcyB0byBvdmVycmlkZSBkZWZhdWx0c1xuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBUZXN0IEFQSSBrZXkgb2JqZWN0XG4gICAqL1xuICBzdGF0aWMgY3JlYXRlQXBpS2V5KG92ZXJyaWRlcyA9IHt9KSB7XG4gICAgbG9nU3RhcnQoJ1Rlc3REYXRhRmFjdG9yeS5jcmVhdGVBcGlLZXknLCBvdmVycmlkZXMpO1xuICAgIFxuICAgIGNvbnN0IGlkID0gdGhpcy5uZXh0SWQoKTtcbiAgICBjb25zdCBhcGlLZXkgPSB7XG4gICAgICBpZDogYGtleS0ke2lkfWAsXG4gICAgICBrZXk6IGB0ZXN0LWFwaS1rZXktJHtpZH0tJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSl9YCxcbiAgICAgIG5hbWU6IGBUZXN0IEFQSSBLZXkgJHtpZH1gLFxuICAgICAgdXNlcklkOiBgdXNlci0ke2lkfWAsXG4gICAgICBpc0FjdGl2ZTogdHJ1ZSxcbiAgICAgIHBlcm1pc3Npb25zOiBbJ3JlYWQnLCAnd3JpdGUnXSxcbiAgICAgIGNyZWF0ZWRBdDogbmV3IERhdGUoKSxcbiAgICAgIGV4cGlyZXNBdDogbmV3IERhdGUoRGF0ZS5ub3coKSArIDMwICogMjQgKiA2MCAqIDYwICogMTAwMCksIC8vIDMwIGRheXNcbiAgICAgIC4uLm92ZXJyaWRlc1xuICAgIH07XG4gICAgXG4gICAgbG9nUmV0dXJuKCdUZXN0RGF0YUZhY3RvcnkuY3JlYXRlQXBpS2V5JywgYXBpS2V5KTtcbiAgICByZXR1cm4gYXBpS2V5O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSB0ZXN0IGxvZyBlbnRyeSB3aXRoIHJlYWxpc3RpYyBwcm9wZXJ0aWVzXG4gICAqIFxuICAgKiBAcGFyYW0ge09iamVjdH0gb3ZlcnJpZGVzIC0gUHJvcGVydGllcyB0byBvdmVycmlkZSBkZWZhdWx0c1xuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBUZXN0IGxvZyBlbnRyeSBvYmplY3RcbiAgICovXG4gIHN0YXRpYyBjcmVhdGVMb2dFbnRyeShvdmVycmlkZXMgPSB7fSkge1xuICAgIGxvZ1N0YXJ0KCdUZXN0RGF0YUZhY3RvcnkuY3JlYXRlTG9nRW50cnknLCBvdmVycmlkZXMpO1xuICAgIFxuICAgIGNvbnN0IGlkID0gdGhpcy5uZXh0SWQoKTtcbiAgICBjb25zdCBsb2dFbnRyeSA9IHtcbiAgICAgIGlkOiBgbG9nLSR7aWR9YCxcbiAgICAgIG1lc3NhZ2U6IGBUZXN0IGxvZyBtZXNzYWdlICR7aWR9YCxcbiAgICAgIGxldmVsOiAnaW5mbycsXG4gICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gICAgICB1c2VySWQ6IGB1c2VyLSR7aWR9YCxcbiAgICAgIHNvdXJjZTogJ3Rlc3QtYXBwbGljYXRpb24nLFxuICAgICAgbWV0YWRhdGE6IHtcbiAgICAgICAgdGVzdElkOiBpZCxcbiAgICAgICAgZW52aXJvbm1lbnQ6ICd0ZXN0J1xuICAgICAgfSxcbiAgICAgIC4uLm92ZXJyaWRlc1xuICAgIH07XG4gICAgXG4gICAgbG9nUmV0dXJuKCdUZXN0RGF0YUZhY3RvcnkuY3JlYXRlTG9nRW50cnknLCBsb2dFbnRyeSk7XG4gICAgcmV0dXJuIGxvZ0VudHJ5O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZXMgYSB0ZXN0IGNvbmZpZ3VyYXRpb24gb2JqZWN0IHdpdGggcmVhbGlzdGljIHByb3BlcnRpZXNcbiAgICogXG4gICAqIEBwYXJhbSB7T2JqZWN0fSBvdmVycmlkZXMgLSBQcm9wZXJ0aWVzIHRvIG92ZXJyaWRlIGRlZmF1bHRzXG4gICAqIEByZXR1cm5zIHtPYmplY3R9IFRlc3QgY29uZmlndXJhdGlvbiBvYmplY3RcbiAgICovXG4gIHN0YXRpYyBjcmVhdGVDb25maWcob3ZlcnJpZGVzID0ge30pIHtcbiAgICBsb2dTdGFydCgnVGVzdERhdGFGYWN0b3J5LmNyZWF0ZUNvbmZpZycsIG92ZXJyaWRlcyk7XG4gICAgXG4gICAgY29uc3QgaWQgPSB0aGlzLm5leHRJZCgpO1xuICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgIGlkOiBgY29uZmlnLSR7aWR9YCxcbiAgICAgIG5hbWU6IGBUZXN0IENvbmZpZ3VyYXRpb24gJHtpZH1gLFxuICAgICAgdmFsdWU6IGB0ZXN0LXZhbHVlLSR7aWR9YCxcbiAgICAgIGVudmlyb25tZW50OiAndGVzdCcsXG4gICAgICB0eXBlOiAnc3RyaW5nJyxcbiAgICAgIGlzQWN0aXZlOiB0cnVlLFxuICAgICAgY3JlYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgdXBkYXRlZEF0OiBuZXcgRGF0ZSgpLFxuICAgICAgLi4ub3ZlcnJpZGVzXG4gICAgfTtcbiAgICBcbiAgICBsb2dSZXR1cm4oJ1Rlc3REYXRhRmFjdG9yeS5jcmVhdGVDb25maWcnLCBjb25maWcpO1xuICAgIHJldHVybiBjb25maWc7XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlcyBtdWx0aXBsZSB0ZXN0IGVudGl0aWVzIHVzaW5nIGEgZmFjdG9yeSBmdW5jdGlvblxuICAgKiBcbiAgICogQHBhcmFtIHtGdW5jdGlvbn0gZmFjdG9yeUZuIC0gRmFjdG9yeSBmdW5jdGlvbiB0byBjcmVhdGUgc2luZ2xlIGVudGl0aWVzXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBjb3VudCAtIE51bWJlciBvZiBlbnRpdGllcyB0byBjcmVhdGVcbiAgICogQHBhcmFtIHtPYmplY3R9IGJhc2VPdmVycmlkZXMgLSBCYXNlIG92ZXJyaWRlcyBhcHBsaWVkIHRvIGFsbCBlbnRpdGllc1xuICAgKiBAcmV0dXJucyB7QXJyYXl9IEFycmF5IG9mIGNyZWF0ZWQgdGVzdCBlbnRpdGllc1xuICAgKi9cbiAgc3RhdGljIGNyZWF0ZU11bHRpcGxlKGZhY3RvcnlGbiwgY291bnQgPSAxMCwgYmFzZU92ZXJyaWRlcyA9IHt9KSB7XG4gICAgbG9nU3RhcnQoJ1Rlc3REYXRhRmFjdG9yeS5jcmVhdGVNdWx0aXBsZScsIHsgY291bnQsIGJhc2VPdmVycmlkZXMgfSk7XG4gICAgXG4gICAgY29uc3QgZW50aXRpZXMgPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGNvdW50OyBpKyspIHtcbiAgICAgIGNvbnN0IGVudGl0eU92ZXJyaWRlcyA9IHsgLi4uYmFzZU92ZXJyaWRlcyB9O1xuICAgICAgZW50aXRpZXMucHVzaChmYWN0b3J5Rm4uY2FsbCh0aGlzLCBlbnRpdHlPdmVycmlkZXMpKTtcbiAgICB9XG4gICAgXG4gICAgbG9nUmV0dXJuKCdUZXN0RGF0YUZhY3RvcnkuY3JlYXRlTXVsdGlwbGUnLCBgJHtlbnRpdGllcy5sZW5ndGh9IGVudGl0aWVzYCk7XG4gICAgcmV0dXJuIGVudGl0aWVzO1xuICB9XG5cbiAgLy8gSW5zdGFuY2UgbWV0aG9kIHdyYXBwZXJzIGZvciBjb21wYXRpYmlsaXR5IHdpdGggVGVzdFN1aXRlQnVpbGRlclxuICBjcmVhdGVVc2VyKG92ZXJyaWRlcykge1xuICAgIHJldHVybiBUZXN0RGF0YUZhY3RvcnkuY3JlYXRlVXNlcihvdmVycmlkZXMpO1xuICB9XG5cbiAgY3JlYXRlQXBpS2V5KG92ZXJyaWRlcykge1xuICAgIHJldHVybiBUZXN0RGF0YUZhY3RvcnkuY3JlYXRlQXBpS2V5KG92ZXJyaWRlcyk7XG4gIH1cblxuICBjcmVhdGVMb2dFbnRyeShvdmVycmlkZXMpIHtcbiAgICByZXR1cm4gVGVzdERhdGFGYWN0b3J5LmNyZWF0ZUxvZ0VudHJ5KG92ZXJyaWRlcyk7XG4gIH1cblxuICBjcmVhdGVDb25maWcob3ZlcnJpZGVzKSB7XG4gICAgcmV0dXJuIFRlc3REYXRhRmFjdG9yeS5jcmVhdGVDb25maWcob3ZlcnJpZGVzKTtcbiAgfVxuXG4gIGNyZWF0ZU11bHRpcGxlKGZhY3RvcnlGbiwgY291bnQsIGJhc2VPdmVycmlkZXMpIHtcbiAgICByZXR1cm4gVGVzdERhdGFGYWN0b3J5LmNyZWF0ZU11bHRpcGxlKGZhY3RvcnlGbi5iaW5kKHRoaXMpLCBjb3VudCwgYmFzZU92ZXJyaWRlcyk7XG4gIH1cblxuICAvLyBTdGF0aWMgbWV0aG9kIGZvciByZXNldHRpbmcgY291bnRlclxuICBzdGF0aWMgcmVzZXQoKSB7XG4gICAgdGhpcy5jb3VudGVyID0gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGVzIHJlbGF0ZWQgZW50aXRpZXMgd2l0aCByZWxhdGlvbnNoaXBzXG4gICAqIFxuICAgKiBAcGFyYW0ge09iamVjdH0gY29uZmlnIC0gQ29uZmlndXJhdGlvbiBmb3IgY3JlYXRpbmcgcmVsYXRlZCBlbnRpdGllc1xuICAgKiBAcmV0dXJucyB7T2JqZWN0fSBPYmplY3Qgd2l0aCBjcmVhdGVkIGVudGl0aWVzIGFuZCByZWxhdGlvbnNoaXBzXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlUmVsYXRlZEVudGl0aWVzKGNvbmZpZykge1xuICAgIGxvZ1N0YXJ0KCdUZXN0RGF0YUZhY3RvcnkuY3JlYXRlUmVsYXRlZEVudGl0aWVzJywgY29uZmlnKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3Qge1xuICAgICAgICB1c2VyQ291bnQgPSAxLFxuICAgICAgICBhcGlLZXlzUGVyVXNlciA9IDEsXG4gICAgICAgIGxvZ3NQZXJVc2VyID0gMVxuICAgICAgfSA9IGNvbmZpZztcbiAgICAgIFxuICAgICAgY29uc3QgdXNlcnMgPSBbXTtcbiAgICAgIGNvbnN0IGFwaUtleXMgPSBbXTtcbiAgICAgIGNvbnN0IGxvZ3MgPSBbXTtcbiAgICAgIFxuICAgICAgLy8gQ3JlYXRlIHVzZXJzIGZpcnN0XG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHVzZXJDb3VudDsgaSsrKSB7XG4gICAgICAgIHVzZXJzLnB1c2godGhpcy5jcmVhdGVVc2VyKCkpO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBDcmVhdGUgQVBJIGtleXMgZm9yIGVhY2ggdXNlclxuICAgICAgdXNlcnMuZm9yRWFjaCh1c2VyID0+IHtcbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBhcGlLZXlzUGVyVXNlcjsgaSsrKSB7XG4gICAgICAgICAgYXBpS2V5cy5wdXNoKHRoaXMuY3JlYXRlQXBpS2V5KHtcbiAgICAgICAgICAgIHVzZXJJZDogdXNlci5pZCxcbiAgICAgICAgICAgIGtleTogYCR7dXNlci51c2VybmFtZX0ta2V5LSR7aSArIDF9YFxuICAgICAgICAgIH0pKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIC8vIENyZWF0ZSBsb2dzIGZvciBlYWNoIHVzZXJcbiAgICAgIHVzZXJzLmZvckVhY2godXNlciA9PiB7XG4gICAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbG9nc1BlclVzZXI7IGkrKykge1xuICAgICAgICAgIGxvZ3MucHVzaCh0aGlzLmNyZWF0ZUxvZ0VudHJ5KHtcbiAgICAgICAgICAgIHVzZXJJZDogdXNlci5pZCxcbiAgICAgICAgICAgIGVuZHBvaW50OiBgL2FwaS91c2Vycy8ke3VzZXIuaWR9L2RhdGEtJHtpICsgMX1gXG4gICAgICAgICAgfSkpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgY29uc3QgcmVzdWx0ID0ge1xuICAgICAgICB1c2VycyxcbiAgICAgICAgYXBpS2V5cyxcbiAgICAgICAgbG9ncyxcbiAgICAgICAgcmVsYXRpb25zaGlwczoge1xuICAgICAgICAgIHVzZXJUb0FwaUtleXM6IHVzZXJzLnJlZHVjZSgoYWNjLCB1c2VyKSA9PiB7XG4gICAgICAgICAgICBhY2NbdXNlci5pZF0gPSBhcGlLZXlzLmZpbHRlcihrZXkgPT4ga2V5LnVzZXJJZCA9PT0gdXNlci5pZCk7XG4gICAgICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgICAgIH0sIHt9KSxcbiAgICAgICAgICB1c2VyVG9Mb2dzOiB1c2Vycy5yZWR1Y2UoKGFjYywgdXNlcikgPT4ge1xuICAgICAgICAgICAgYWNjW3VzZXIuaWRdID0gbG9ncy5maWx0ZXIobG9nID0+IGxvZy51c2VySWQgPT09IHVzZXIuaWQpO1xuICAgICAgICAgICAgcmV0dXJuIGFjYztcbiAgICAgICAgICB9LCB7fSlcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIFxuICAgICAgbG9nUmV0dXJuKCdUZXN0RGF0YUZhY3RvcnkuY3JlYXRlUmVsYXRlZEVudGl0aWVzJywgYGNyZWF0ZWQgJHt1c2Vycy5sZW5ndGh9IHVzZXJzLCAke2FwaUtleXMubGVuZ3RofSBBUEkga2V5cywgJHtsb2dzLmxlbmd0aH0gbG9nc2ApO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgbG9nUmV0dXJuKCdUZXN0RGF0YUZhY3RvcnkuY3JlYXRlUmVsYXRlZEVudGl0aWVzJywgYGVycm9yOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cbn1cblxubW9kdWxlLmV4cG9y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QUl3QyxDQUFDLEdBQUcsQ0FBQyxFQUFFQSxDQUFDLEdBQUdVLFdBQVcsRUFBRVYsQ0FBQyxFQUFFLEVBQUU7VUFDcENhLElBQUksQ0FBQ1gsSUFBSSxDQUFDLElBQUksQ0FBQ3BCLGNBQWMsQ0FBQztZQUM1QkosTUFBTSxFQUFFbEIsSUFBSSxDQUFDRCxFQUFFO1lBQ2Z3RCxRQUFRLEVBQUUsY0FBY3ZELElBQUksQ0FBQ0QsRUFBRSxTQUFTeUMsQ0FBQyxHQUFHLENBQUM7VUFDL0MsQ0FBQyxDQUFDLENBQUM7UUFDTDtNQUNGLENBQUMsQ0FBQztNQUVGLE1BQU1nQixNQUFNLEdBQUc7UUFDYkwsS0FBSztRQUNMQyxPQUFPO1FBQ1BDLElBQUk7UUFDSkksYUFBYSxFQUFFO1VBQ2JDLGFBQWEsRUFBRVAsS0FBSyxDQUFDUSxNQUFNLENBQUMsQ0FBQ0MsR0FBRyxFQUFFNUQsSUFBSSxLQUFLO1lBQ3pDNEQsR0FBRyxDQUFDNUQsSUFBSSxDQUFDRCxFQUFFLENBQUMsR0FBR3FELE9BQU8sQ0FBQ1MsTUFBTSxDQUFDakQsR0FBRyxJQUFJQSxHQUFHLENBQUNNLE1BQU0sS0FBS2xCLElBQUksQ0FBQ0QsRUFBRSxDQUFDO1lBQzVELE9BQU82RCxHQUFHO1VBQ1osQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1VBQ05FLFVBQVUsRUFBRVgsS0FBSyxDQUFDUSxNQUFNLENBQUMsQ0FBQ0MsR0FBRyxFQUFFNUQsSUFBSSxLQUFLO1lBQ3RDNEQsR0FBRyxDQUFDNUQsSUFBSSxDQUFDRCxFQUFFLENBQUMsR0FBR3NELElBQUksQ0FBQ1EsTUFBTSxDQUFDRSxHQUFHLElBQUlBLEdBQUcsQ0FBQzdDLE1BQU0sS0FBS2xCLElBQUksQ0FBQ0QsRUFBRSxDQUFDO1lBQ3pELE9BQU82RCxHQUFHO1VBQ1osQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNQO01BQ0YsQ0FBQztNQUVEcEUsU0FBUyxDQUFDLHVDQUF1QyxFQUFFLFdBQVcyRCxLQUFLLENBQUNQLE1BQU0sV0FBV1EsT0FBTyxDQUFDUixNQUFNLGNBQWNTLElBQUksQ0FBQ1QsTUFBTSxPQUFPLENBQUM7TUFDcEksT0FBT1ksTUFBTTtJQUNmLENBQUMsQ0FBQyxPQUFPUSxLQUFLLEVBQUU7TUFDZHhFLFNBQVMsQ0FBQyx1Q0FBdUMsRUFBRSxVQUFVd0UsS0FBSyxDQUFDeEMsT0FBTyxFQUFFLENBQUM7TUFDN0UsTUFBTXdDLEtBQUs7SUFDYjtFQUNGO0FBQ0Y7QUFFQUMsTUFBTSxDQUFDQyxPQUFPLEdBQUc7RUFDZnhFO0FBQ0YsQ0FBQyIsImlnbm9yZUxpc3QiOltdfQ==