05baf437b7048789ebdb3e21fd4af89c
/**
 * Mock Management System for Consistent API and Service Mocking - TypeScript Implementation
 *
 * This class focuses solely on mock management and lifecycle concerns.
 * It provides centralized mock management that eliminates duplicate patterns.
 */
import { logStart, logReturn } from '../../lib/logUtils.js';
/**
 * Mock Management System for Consistent API and Service Mocking
 *
 * This class provides centralized mock management that eliminates duplicate
 * mock patterns across test files. It uses qtests utilities for consistent
 * mocking while providing advanced mock configuration capabilities.
 */
class MockManager {
    constructor() {
        this.mocks = new Map();
        this.restorations = new Map();
    }
    /**
     * Sets up API client mocks using qtests stubMethod utility
     */
    setupApiClientMocks(customResponses = {}) {
        logStart('MockManager.setupApiClientMocks', customResponses);
        try {
            // Default API responses
            const defaultResponses = {
                get: { status: 200, data: {} },
                post: { status: 201, data: { id: 1 } },
                put: { status: 200, data: { updated: true } },
                delete: { status: 204, data: null }
            };
            const responses = { ...defaultResponses, ...customResponses };
            // Create mock API client object
            const mockApiClient = {
                get: () => Promise.resolve(responses.get),
                post: () => Promise.resolve(responses.post),
                put: () => Promise.resolve(responses.put),
                delete: () => Promise.resolve(responses.delete),
                request: () => Promise.resolve(responses.get)
            };
            this.mocks.set('apiClient', mockApiClient);
            // If we have a global HTTP client to stub, stub it
            if (typeof globalThis.fetch === 'function') {
                const originalFetch = globalThis.fetch;
                globalThis.fetch = (url, options = {}) => {
                    const method = (options.method || 'GET').toLowerCase();
                    const response = responses[method] || responses.get;
                    return Promise.resolve({
                        ok: response.status < 400,
                        status: response.status,
                        json: () => Promise.resolve(response.data),
                        text: () => Promise.resolve(JSON.stringify(response.data))
                    });
                };
                this.restorations.set('fetch', () => {
                    globalThis.fetch = originalFetch;
                });
            }
            logReturn('MockManager.setupApiClientMocks', 'completed');
        }
        catch (error) {
            logReturn('MockManager.setupApiClientMocks', `error: ${error.message}`);
            throw error;
        }
    }
    /**
     * Sets up console and notification mocks using qtests utilities
     */
    setupConsoleMocks() {
        logStart('MockManager.setupConsoleMocks');
        try {
            // Dynamic import for mockConsole
            const mockConsole = async () => {
                const module = await import('../mockConsole.js');
                return module.mockConsole;
            };
            // Create console mocks - placeholder for now
            const consoleMocks = {
                log: () => { },
                error: () => { },
                warn: () => { },
                restore: () => { }
            };
            this.mocks.set('console', consoleMocks);
            this.restorations.set('console', consoleMocks.restore);
            logReturn('MockManager.setupConsoleMocks', consoleMocks);
            return consoleMocks;
        }
        catch (error) {
            logReturn('MockManager.setupConsoleMocks', `error: ${error.message}`);
            throw error;
        }
    }
    /**
     * Gets a specific mock by name
     */
    getMock(mockName) {
        logStart('MockManager.getMock', mockName);
        const mock = this.mocks.get(mockName);
        if (mock) {
            logReturn('MockManager.getMock', 'found');
            return mock;
        }
        else {
            logReturn('MockManager.getMock', 'not found');
            return null;
        }
    }
    /**
     * Clears all mocks and restores original functions
     */
    clearAll() {
        logStart('MockManager.clearAll');
        try {
            // Restore all mocked functions
            this.restorations.forEach((restore, mockName) => {
                try {
                    restore();
                }
                catch (error) {
                    // Ignore restoration errors - function may already be restored
                }
            });
            // Clear all stored mocks and restorations
            this.mocks.clear();
            this.restorations.clear();
            logReturn('MockManager.clearAll', 'completed');
        }
        catch (error) {
            logReturn('MockManager.clearAll', `error: ${error.message}`);
            throw error;
        }
    }
    /**
     * Sets up environment variable mocks
     */
    setupEnvironmentMocks(envVars = {}) {
        logStart('MockManager.setupEnvironmentMocks', envVars);
        try {
            const originalEnv = {};
            // Backup and set environment variables
            Object.entries(envVars).forEach(([key, value]) => {
                originalEnv[key] = process.env[key];
                process.env[key] = value;
            });
            // Create restoration function
            const restore = () => {
                Object.entries(originalEnv).forEach(([key, value]) => {
                    if (value === undefined) {
                        delete process.env[key];
                    }
                    else {
                        process.env[key] = value;
                    }
                });
            };
            this.mocks.set('environment', envVars);
            this.restorations.set('environment', restore);
            logReturn('MockManager.setupEnvironmentMocks', restore);
            return restore;
        }
        catch (error) {
            logReturn('MockManager.setupEnvironmentMocks', `error: ${error.message}`);
            throw error;
        }
    }
    /**
     * Sets up HTTP response mocks
     */
    setupHttpMocks(responses = []) {
        logStart('MockManager.setupHttpMocks', responses);
        try {
            // Simple HTTP mock setup
            const httpMocks = {
                responses: responses,
                getResponse: (index) => responses[index] || { status: 404, data: null }
            };
            this.mocks.set('http', httpMocks);
            logReturn('MockManager.setupHttpMocks', 'completed');
        }
        catch (error) {
            logReturn('MockManager.setupHttpMocks', `error: ${error.message}`);
            throw error;
        }
    }
}
// Export MockManager using ES module syntax
export { MockManager };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS91dGlscy90ZXN0aW5nL21vY2tNYW5hZ2VyLnRzIiwibWFwcGluZ3MiOiJBQUFBOzs7OztHQUtHO0FBRUgsT0FBTyxFQUFFLFFBQVEsRUFBRSxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQXVCNUQ7Ozs7OztHQU1HO0FBQ0gsTUFBTSxXQUFXO0lBSWY7UUFDRSxJQUFJLENBQUMsS0FBSyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLFlBQVksR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ2hDLENBQUM7SUFFRDs7T0FFRztJQUNILG1CQUFtQixDQUFDLGtCQUFnRCxFQUFFO1FBQ3BFLFFBQVEsQ0FBQyxpQ0FBaUMsRUFBRSxlQUFlLENBQUMsQ0FBQztRQUU3RCxJQUFJLENBQUM7WUFDSCx3QkFBd0I7WUFDeEIsTUFBTSxnQkFBZ0IsR0FBaUM7Z0JBQ3JELEdBQUcsRUFBRSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsRUFBRTtnQkFDOUIsSUFBSSxFQUFFLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLEVBQUUsQ0FBQyxFQUFFLEVBQUU7Z0JBQ3RDLEdBQUcsRUFBRSxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxFQUFFO2dCQUM3QyxNQUFNLEVBQUUsRUFBRSxNQUFNLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUU7YUFDcEMsQ0FBQztZQUVGLE1BQU0sU0FBUyxHQUFHLEVBQUUsR0FBRyxnQkFBZ0IsRUFBRSxHQUFHLGVBQWUsRUFBRSxDQUFDO1lBRTlELGdDQUFnQztZQUNoQyxNQUFNLGFBQWEsR0FBa0I7Z0JBQ25DLEdBQUcsRUFBRSxHQUFHLEVBQUUsQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUM7Z0JBQ3pDLElBQUksRUFBRSxH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Im5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3V0aWxzL3Rlc3RpbmcvbW9ja01hbmFnZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBNb2NrIE1hbmFnZW1lbnQgU3lzdGVtIGZvciBDb25zaXN0ZW50IEFQSSBhbmQgU2VydmljZSBNb2NraW5nIC0gVHlwZVNjcmlwdCBJbXBsZW1lbnRhdGlvblxuICogXG4gKiBUaGlzIGNsYXNzIGZvY3VzZXMgc29sZWx5IG9uIG1vY2sgbWFuYWdlbWVudCBhbmQgbGlmZWN5Y2xlIGNvbmNlcm5zLlxuICogSXQgcHJvdmlkZXMgY2VudHJhbGl6ZWQgbW9jayBtYW5hZ2VtZW50IHRoYXQgZWxpbWluYXRlcyBkdXBsaWNhdGUgcGF0dGVybnMuXG4gKi9cblxuaW1wb3J0IHsgbG9nU3RhcnQsIGxvZ1JldHVybiB9IGZyb20gJy4uLy4uL2xpYi9sb2dVdGlscy5qcyc7XG5cbi8vIFR5cGUgZGVmaW5pdGlvbnNcbmludGVyZmFjZSBNb2NrUmVzcG9uc2Uge1xuICBzdGF0dXM6IG51bWJlcjtcbiAgZGF0YTogYW55O1xufVxuXG5pbnRlcmZhY2UgTW9ja0FwaUNsaWVudCB7XG4gIGdldDogKCkgPT4gUHJvbWlzZTxNb2NrUmVzcG9uc2U+O1xuICBwb3N0OiAoKSA9PiBQcm9taXNlPE1vY2tSZXNwb25zZT47XG4gIHB1dDogKCkgPT4gUHJvbWlzZTxNb2NrUmVzcG9uc2U+O1xuICBkZWxldGU6ICgpID0+IFByb21pc2U8TW9ja1Jlc3BvbnNlPjtcbiAgcmVxdWVzdDogKCkgPT4gUHJvbWlzZTxNb2NrUmVzcG9uc2U+O1xufVxuXG5pbnRlcmZhY2UgQ29uc29sZU1vY2tzIHtcbiAgbG9nOiBhbnk7XG4gIGVycm9yOiBhbnk7XG4gIHdhcm46IGFueTtcbiAgcmVzdG9yZTogKCkgPT4gdm9pZDtcbn1cblxuLyoqXG4gKiBNb2NrIE1hbmFnZW1lbnQgU3lzdGVtIGZvciBDb25zaXN0ZW50IEFQSSBhbmQgU2VydmljZSBNb2NraW5nXG4gKiBcbiAqIFRoaXMgY2xhc3MgcHJvdmlkZXMgY2VudHJhbGl6ZWQgbW9jayBtYW5hZ2VtZW50IHRoYXQgZWxpbWluYXRlcyBkdXBsaWNhdGVcbiAqIG1vY2sgcGF0dGVybnMgYWNyb3NzIHRlc3QgZmlsZXMuIEl0IHVzZXMgcXRlc3RzIHV0aWxpdGllcyBmb3IgY29uc2lzdGVudFxuICogbW9ja2luZyB3aGlsZSBwcm92aWRpbmcgYWR2YW5jZWQgbW9jayBjb25maWd1cmF0aW9uIGNhcGFiaWxpdGllcy5cbiAqL1xuY2xhc3MgTW9ja01hbmFnZXIge1xuICBwcml2YXRlIG1vY2tzOiBNYXA8c3RyaW5nLCBhbnk+O1xuICBwcml2YXRlIHJlc3RvcmF0aW9uczogTWFwPHN0cmluZywgKCkgPT4gdm9pZD47XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5tb2NrcyA9IG5ldyBNYXAoKTtcbiAgICB0aGlzLnJlc3RvcmF0aW9ucyA9IG5ldyBNYXAoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHVwIEFQSSBjbGllbnQgbW9ja3MgdXNpbmcgcXRlc3RzIHN0dWJNZXRob2QgdXRpbGl0eVxuICAgKi9cbiAgc2V0dXBBcGlDbGllbnRNb2NrcyhjdXN0b21SZXNwb25zZXM6IFJlY29yZDxzdHJpbmcsIE1vY2tSZXNwb25zZT4gPSB7fSk6IHZvaWQge1xuICAgIGxvZ1N0YXJ0KCdNb2NrTWFuYWdlci5zZXR1cEFwaUNsaWVudE1vY2tzJywgY3VzdG9tUmVzcG9uc2VzKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgLy8gRGVmYXVsdCBBUEkgcmVzcG9uc2VzXG4gICAgICBjb25zdCBkZWZhdWx0UmVzcG9uc2VzOiBSZWNvcmQ8c3RyaW5nLCBNb2NrUmVzcG9uc2U+ID0ge1xuICAgICAgICBnZXQ6IHsgc3RhdHVzOiAyMDAsIGRhdGE6IHt9IH0sXG4gICAgICAgIHBvc3Q6IHsgc3RhdHVzOiAyMDEsIGRhdGE6IHsgaWQ6IDEgfSB9LFxuICAgICAgICBwdXQ6IHsgc3RhdHVzOiAyMDAsIGRhdGE6IHsgdXBkYXRlZDogdHJ1ZSB9IH0sXG4gICAgICAgIGRlbGV0ZTogeyBzdGF0dXM6IDIwNCwgZGF0YTogbnVsbCB9XG4gICAgICB9O1xuICAgICAgXG4gICAgICBjb25zdCByZXNwb25zZXMgPSB7IC4uLmRlZmF1bHRSZXNwb25zZXMsIC4uLmN1c3RvbVJlc3BvbnNlcyB9O1xuICAgICAgXG4gICAgICAvLyBDcmVhdGUgbW9jayBBUEkgY2xpZW50IG9iamVjdFxuICAgICAgY29uc3QgbW9ja0FwaUNsaWVudDogTW9ja0FwaUNsaWVudCA9IHtcbiAgICAgICAgZ2V0OiAoKSA9PiBQcm9taXNlLnJlc29sdmUocmVzcG9uc2VzLmdldCksXG4gICAgICAgIHBvc3Q6ICgpID0+IFByb21pc2UucmVzb2x2ZShyZXNwb25zZXMucG9zdCksXG4gICAgICAgIHB1dDogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHJlc3BvbnNlcy5wdXQpLFxuICAgICAgICBkZWxldGU6ICgpID0+IFByb21pc2UucmVzb2x2ZShyZXNwb25zZXMuZGVsZXRlKSxcbiAgICAgICAgcmVxdWVzdDogKCkgPT4gUHJvbWlzZS5yZXNvbHZlKHJlc3BvbnNlcy5nZXQpXG4gICAgICB9O1xuICAgICAgXG4gICAgICB0aGlzLm1vY2tzLnNldCgnYXBpQ2xpZW50JywgbW9ja0FwaUNsaWVudCk7XG4gICAgICBcbiAgICAgIC8vIElmIHdlIGhhdmUgYSBnbG9iYWwgSFRUUCBjbGllbnQgdG8gc3R1Yiwgc3R1YiBpdFxuICAgICAgaWYgKHR5cGVvZiAoZ2xvYmFsVGhpcyBhcyBhbnkpLmZldGNoID09PSAnZnVuY3Rpb24nKSB7XG4gICAgICAgIGNvbnN0IG9yaWdpbmFsRmV0Y2ggPSAoZ2xvYmFsVGhpcyBhcyBhbnkpLmZldGNoO1xuICAgICAgICAoZ2xvYmFsVGhpcyBhcyBhbnkpLmZldGNoID0gKHVybDogc3RyaW5nLCBvcHRpb25zOiBhbnkgPSB7fSkgPT4ge1xuICAgICAgICAgIGNvbnN0IG1ldGhvZCA9IChvcHRpb25zLm1ldGhvZCB8fCAnR0VUJykudG9Mb3dlckNhc2UoKTtcbiAgICAgICAgICBjb25zdCByZXNwb25zZSA9IHJlc3BvbnNlc1ttZXRob2RdIHx8IHJlc3BvbnNlcy5nZXQ7XG4gICAgICAgICAgXG4gICAgICAgICAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh7XG4gICAgICAgICAgICBvazogcmVzcG9uc2Uuc3RhdHVzIDwgNDAwLFxuICAgICAgICAgICAgc3RhdHVzOiByZXNwb25zZS5zdGF0dXMsXG4gICAgICAgICAgICBqc29uOiAoKSA9PiBQcm9taXNlLnJlc29sdmUocmVzcG9uc2UuZGF0YSksXG4gICAgICAgICAgICB0ZXh0OiAoKSA9PiBQcm9taXNlLnJlc29sdmUoSlNPTi5zdHJpbmdpZnkocmVzcG9uc2UuZGF0YSkpXG4gICAgICAgICAgfSk7XG4gICAgICAgIH07XG4gICAgICAgIFxuICAgICAgICB0aGlzLnJlc3RvcmF0aW9ucy5zZXQoJ2ZldGNoJywgKCkgPT4ge1xuICAgICAgICAgIChnbG9iYWxUaGlzIGFzIGFueSkuZmV0Y2ggPSBvcmlnaW5hbEZldGNoO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgbG9nUmV0dXJuKCdNb2NrTWFuYWdlci5zZXR1cEFwaUNsaWVudE1vY2tzJywgJ2NvbXBsZXRlZCcpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGxvZ1JldHVybignTW9ja01hbmFnZXIuc2V0dXBBcGlDbGllbnRNb2NrcycsIGBlcnJvcjogJHtlcnJvci5tZXNzYWdlfWApO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldHMgdXAgY29uc29sZSBhbmQgbm90aWZpY2F0aW9uIG1vY2tzIHVzaW5nIHF0ZXN0cyB1dGlsaXRpZXNcbiAgICovXG4gIHNldHVwQ29uc29sZU1vY2tzKCk6IENvbnNvbGVNb2NrcyB7XG4gICAgbG9nU3RhcnQoJ01vY2tNYW5hZ2VyLnNldHVwQ29uc29sZU1vY2tzJyk7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIC8vIER5bmFtaWMgaW1wb3J0IGZvciBtb2NrQ29uc29sZVxuICAgICAgY29uc3QgbW9ja0NvbnNvbGUgPSBhc3luYyAoKSA9PiB7XG4gICAgICAgIGNvbnN0IG1vZHVsZSA9IGF3YWl0IGltcG9ydCgnLi4vbW9ja0NvbnNvbGUuanMnKTtcbiAgICAgICAgcmV0dXJuIG1vZHVsZS5tb2NrQ29uc29sZTtcbiAgICAgIH07XG4gICAgICBcbiAgICAgIC8vIENyZWF0ZSBjb25zb2xlIG1vY2tzIC0gcGxhY2Vob2xkZXIgZm9yIG5vd1xuICAgICAgY29uc3QgY29uc29sZU1vY2tzOiBDb25zb2xlTW9ja3MgPSB7XG4gICAgICAgIGxvZzogKCkgPT4ge30sXG4gICAgICAgIGVycm9yOiAoKSA9PiB7fSxcbiAgICAgICAgd2FybjogKCkgPT4ge30sXG4gICAgICAgIHJlc3RvcmU6ICgpID0+IHt9XG4gICAgICB9O1xuICAgICAgXG4gICAgICB0aGlzLm1vY2tzLnNldCgnY29uc29sZScsIGNvbnNvbGVNb2Nrcyk7XG4gICAgICB0aGlzLnJlc3RvcmF0aW9ucy5zZXQoJ2NvbnNvbGUnLCBjb25zb2xlTW9ja3MucmVzdG9yZSk7XG4gICAgICBcbiAgICAgIGxvZ1JldHVybignTW9ja01hbmFnZXIuc2V0dXBDb25zb2xlTW9ja3MnLCBjb25zb2xlTW9ja3MpO1xuICAgICAgcmV0dXJuIGNvbnNvbGVNb2NrcztcbiAgICB9IGNhdGNoIChlcnJvcjogYW55KSB7XG4gICAgICBsb2dSZXR1cm4oJ01vY2tNYW5hZ2VyLnNldHVwQ29uc29sZU1vY2tzJywgYGVycm9yOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0cyBhIHNwZWNpZmljIG1vY2sgYnkgbmFtZVxuICAgKi9cbiAgZ2V0TW9jayhtb2NrTmFtZTogc3RyaW5nKTogYW55IHwgbnVsbCB7XG4gICAgbG9nU3RhcnQoJ01vY2tNYW5hZ2VyLmdldE1vY2snLCBtb2NrTmFtZSk7XG4gICAgXG4gICAgY29uc3QgbW9jayA9IHRoaXMubW9ja3MuZ2V0KG1vY2tOYW1lKTtcbiAgICBpZiAobW9jaykge1xuICAgICAgbG9nUmV0dXJuKCdNb2NrTWFuYWdlci5nZXRNb2NrJywgJ2ZvdW5kJyk7XG4gICAgICByZXR1cm4gbW9jaztcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nUmV0dXJuKCdNb2NrTWFuYWdlci5nZXRNb2NrJywgJ25vdCBmb3VuZCcpO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENsZWFycyBhbGwgbW9ja3MgYW5kIHJlc3RvcmVzIG9yaWdpbmFsIGZ1bmN0aW9uc1xuICAgKi9cbiAgY2xlYXJBbGwoKTogdm9pZCB7XG4gICAgbG9nU3RhcnQoJ01vY2tNYW5hZ2VyLmNsZWFyQWxsJyk7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIC8vIFJlc3RvcmUgYWxsIG1vY2tlZCBmdW5jdGlvbnNcbiAgICAgIHRoaXMucmVzdG9yYXRpb25zLmZvckVhY2goKHJlc3RvcmUsIG1vY2tOYW1lKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgcmVzdG9yZSgpO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIC8vIElnbm9yZSByZXN0b3JhdGlvbiBlcnJvcnMgLSBmdW5jdGlvbiBtYXkgYWxyZWFkeSBiZSByZXN0b3JlZFxuICAgICAgICB9XG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgLy8gQ2xlYXIgYWxsIHN0b3JlZCBtb2NrcyBhbmQgcmVzdG9yYXRpb25zXG4gICAgICB0aGlzLm1vY2tzLmNsZWFyKCk7XG4gICAgICB0aGlzLnJlc3RvcmF0aW9ucy5jbGVhcigpO1xuICAgICAgXG4gICAgICBsb2dSZXR1cm4oJ01vY2tNYW5hZ2VyLmNsZWFyQWxsJywgJ2NvbXBsZXRlZCcpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGxvZ1JldHVybignTW9ja01hbmFnZXIuY2xlYXJBbGwnLCBgZXJyb3I6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXRzIHVwIGVudmlyb25tZW50IHZhcmlhYmxlIG1vY2tzXG4gICAqL1xuICBzZXR1cEVudmlyb25tZW50TW9ja3MoZW52VmFyczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9KTogKCkgPT4gdm9pZCB7XG4gICAgbG9nU3RhcnQoJ01vY2tNYW5hZ2VyLnNldHVwRW52aXJvbm1lbnRNb2NrcycsIGVudlZhcnMpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICBjb25zdCBvcmlnaW5hbEVudjogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgdW5kZWZpbmVkPiA9IHt9O1xuICAgICAgXG4gICAgICAvLyBCYWNrdXAgYW5kIHNldCBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgICAgIE9iamVjdC5lbnRyaWVzKGVudlZhcnMpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgICBvcmlnaW5hbEVudltrZXldID0gcHJvY2Vzcy5lbnZba2V5XTtcbiAgICAgICAgcHJvY2Vzcy5lbnZba2V5XSA9IHZhbHVlO1xuICAgICAgfSk7XG4gICAgICBcbiAgICAgIC8vIENyZWF0ZSByZXN0b3JhdGlvbiBmdW5jdGlvblxuICAgICAgY29uc3QgcmVzdG9yZSA9ICgpID0+IHtcbiAgICAgICAgT2JqZWN0LmVudHJpZXMob3JpZ2luYWxFbnYpLmZvckVhY2goKFtrZXksIHZhbHVlXSkgPT4ge1xuICAgICAgICAgIGlmICh2YWx1ZSA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICBkZWxldGUgcHJvY2Vzcy5lbnZba2V5XTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcHJvY2Vzcy5lbnZba2V5XSA9IHZhbHVlO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9O1xuICAgICAgXG4gICAgICB0aGlzLm1vY2tzLnNldCgnZW52aXJvbm1lbnQnLCBlbnZWYXJzKTtcbiAgICAgIHRoaXMucmVzdG9yYXRpb25zLnNldCgnZW52aXJvbm1lbnQnLCByZXN0b3JlKTtcbiAgICAgIFxuICAgICAgbG9nUmV0dXJuKCdNb2NrTWFuYWdlci5zZXR1cEVudmlyb25tZW50TW9ja3MnLCByZXN0b3JlKTtcbiAgICAgIHJldHVybiByZXN0b3JlO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGxvZ1JldHVybignTW9ja01hbmFnZXIuc2V0dXBFbnZpcm9ubWVudE1vY2tzJywgYGVycm9yOiAke2Vycm9yLm1lc3NhZ2V9YCk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2V0cyB1cCBIVFRQIHJlc3BvbnNlIG1vY2tzXG4gICAqL1xuICBzZXR1cEh0dHBNb2NrcyhyZXNwb25zZXM6IGFueVtdID0gW10pOiB2b2lkIHtcbiAgICBsb2dTdGFydCgnTW9ja01hbmFnZXIuc2V0dXBIdHRwTW9ja3MnLCByZXNwb25zZXMpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICAvLyBTaW1wbGUgSFRUUCBtb2NrIHNldHVwXG4gICAgICBjb25zdCBodHRwTW9ja3MgPSB7XG4gICAgICAgIHJlc3BvbnNlczogcmVzcG9uc2VzLFxuICAgICAgICBnZXRSZXNwb25zZTogKGluZGV4OiBudW1iZXIpID0+IHJlc3BvbnNlc1tpbmRleF0gfHwgeyBzdGF0dXM6IDQwNCwgZGF0YTogbnVsbCB9XG4gICAgICB9O1xuICAgICAgXG4gICAgICB0aGlzLm1vY2tzLnNldCgnaHR0cCcsIGh0dHBNb2Nrcyk7XG4gICAgICBsb2dSZXR1cm4oJ01vY2tNYW5hZ2VyLnNldHVwSHR0cE1vY2tzJywgJ2NvbXBsZXRlZCcpO1xuICAgIH0gY2F0Y2ggKGVycm9yOiBhbnkpIHtcbiAgICAgIGxvZ1JldHVybignTW9ja01hbmFnZXIuc2V0dXBIdHRwTW9ja3MnLCBgZXJyb3I6ICR7ZXJyb3IubWVzc2FnZX1gKTtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxufVxuXG4vLyBFeHBvcnQgTW9ja01hbmFnZXIgdXNpbmcgRVMgbW9kdWxlIHN5bnRheFxuZXhwb3J0IHsgTW9ja01hbmFnZXIgfTsiXSwidmVyc2lvbiI6M30=