e01bb95d2952c54b2101dee6e6219150
/**
 * Email Sender Core Utility - TypeScript Implementation
 *
 * This module provides the core email sending functionality and batch operations.
 * It coordinates with other email utilities for validation, formatting, and history.
 */
import { logStart, logReturn } from '../../lib/logUtils.js';
import { validateEmail } from './emailValidator.js';
import { formatEmailContent } from './emailFormatter.js';
import { addToHistory } from './emailHistory.js';
/**
 * Core sendEmail Mock Function
 *
 * Purpose: Prepares email data for external delivery without coupling to a mailing service.
 * This lightweight approach avoids additional dependencies while enabling tests that expect
 * email payloads and comprehensive verification of email workflows.
 */
function sendEmail(recipient, subject, body, options = {}) {
    logStart('sendEmail', recipient, subject, body, options);
    // Validate input parameters
    if (!validateEmail(recipient)) {
        const error = {
            success: false,
            emailData: null,
            message: `Invalid email address: ${recipient}`,
            timestamp: new Date(),
            error: 'INVALID_RECIPIENT'
        };
        // Store failed attempt in history for testing
        addToHistory(error);
        console.log(`[MOCK EMAIL ERROR] Invalid recipient: ${recipient}`);
        logReturn('sendEmail', error);
        return error;
    }
    // Format email content
    const formatted = formatEmailContent(subject, body);
    // Create email data structure
    const emailData = {
        to: recipient,
        subject: formatted.subject,
        body: formatted.body,
        ...options
    };
    // Create response object
    const response = {
        success: true,
        emailData,
        message: "Client should send this email using preferred mail service",
        timestamp: new Date(),
        id: `mock-email-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`
    };
    // Store in history for test verification
    addToHistory(response);
    // Log email details for development and debugging
    console.log(`[MOCK EMAIL] To: ${recipient}, Subject: ${formatted.subject}`);
    if (options.verbose) {
        console.log(`[MOCK EMAIL] Body: ${formatted.body.substring(0, 100)}${formatted.body.length > 100 ? '...' : ''}`);
    }
    logReturn('sendEmail', response);
    return response;
}
/**
 * Send multiple emails in batch
 *
 * This function provides efficient batch email processing for applications
 * that need to send multiple emails. It processes all emails and returns
 * a summary with individual results.
 */
function sendEmailBatch(emails, options = {}) {
    logStart('sendEmailBatch', emails, options);
    if (!Array.isArray(emails)) {
        const error = {
            success: false,
            message: 'sendEmailBatch requires an array of email objects',
            results: [],
            summary: { total: 0, successful: 0, failed: 1 }
        };
        logReturn('sendEmailBatch', error);
        return error;
    }
    const results = [];
    let successful = 0;
    let failed = 0;
    // Process each email individually
    for (const email of emails) {
        try {
            const result = sendEmail(email.to || email.recipient || '', email.subject, email.body, { ...options, ...email.options });
            results.push(result);
            if (result.success) {
                successful++;
            }
            else {
                failed++;
            }
        }
        catch (error) {
            const errorResult = {
                success: false,
                emailData: null,
                message: `Failed to process email: ${error.message}`,
                timestamp: new Date(),
                error: 'PROCESSING_ERROR'
            };
            results.push(errorResult);
            failed++;
        }
    }
    const batchResult = {
        success: failed === 0,
        results,
        summary: {
            total: emails.length,
            successful,
            failed
        }
    };
    if (failed > 0) {
        batchResult.message = `Batch completed with ${failed} failures out of ${emails.length} emails`;
    }
    else {
        batchResult.message = `Batch completed successfully - ${successful} emails processed`;
    }
    logReturn('sendEmailBatch', batchResult);
    return batchResult;
}
// Export using ES module syntax
export { sendEmail, sendEmailBatch };
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS91dGlscy9lbWFpbC9lbWFpbFNlbmRlci50cyIsIm1hcHBpbmdzIjoiQUFBQTs7Ozs7R0FLRztBQUVILE9BQU8sRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDNUQsT0FBTyxFQUFFLGFBQWEsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3BELE9BQU8sRUFBRSxrQkFBa0IsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBQ3pELE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxtQkFBbUIsQ0FBQztBQW9DakQ7Ozs7OztHQU1HO0FBQ0gsU0FBUyxTQUFTLENBQUMsU0FBaUIsRUFBRSxPQUFlLEVBQUUsSUFBWSxFQUFFLFVBQXdCLEVBQUU7SUFDN0YsUUFBUSxDQUFDLFdBQVcsRUFBRSxTQUFTLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxPQUFPLENBQUMsQ0FBQztJQUV6RCw0QkFBNEI7SUFDNUIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxTQUFTLENBQUMsRUFBRSxDQUFDO1FBQzlCLE1BQU0sS0FBSyxHQUFrQjtZQUMzQixPQUFPLEVBQUUsS0FBSztZQUNkLFNBQVMsRUFBRSxJQUFJO1lBQ2YsT0FBTyxFQUFFLDBCQUEwQixTQUFTLEVBQUU7WUFDOUMsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO1lBQ3JCLEtBQUssRUFBRSxtQkFBbUI7U0FDM0IsQ0FBQztRQUVGLDhDQUE4QztRQUM5QyxZQUFZLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFcEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyx5Q0FBeUMsU0FBUyxFQUFFLENBQUMsQ0FBQztRQUNsRSxTQUFTLENBQUMsV0FBVyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzlCLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELHVCQUF1QjtJQUN2QixNQUFNLFNBQVMsR0FBRyxrQkFBa0IsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFFcEQsOEJBQThCO0lBQzlCLE1BQU0sU0FBUyxHQUFHO1FBQ2hCLEVBQUUsRUFBRSxTQUFTO1FBQ2IsT0FBTyxFQUFFLFNBQVMsQ0FBQyxPQUFPO1FBQzFCLElBQUksRUFBRSxTQUFTLENBQUMsSUFBSTtRQUNwQixHQUFHLE9BQU87S0FDWCxDQUFDO0lBRUYseUJBQXlCO0lBQ3pCLE1BQU0sUUFBUSxHQUFrQjtRQUM5QixPQUFPLEVBQUUsSUFBSTtRQUNiLFNBQVM7UUFDVCxPQUFPLEVBQUUsNERBQTREO1FBQ3JFLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRTtRQUNyQixFQUFFLEVBQUUsY0FBYyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFO0tBQzFFLENBQUM7SUFFRix5Q0FBeUM7SUFDekMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBRXZCLGtEQUFrRDtJQUNsRCxPQUFPLENBQUMsR0FBRyxDQUFDLG9CQUFvQixTQUFTLGNBQWMsU0FBUyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUM7SUFDNUUsSUFBSSxPQUFPLENBQUMsT0FBTyxFQUFFLENBQUM7UUFDcEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsU0FBUyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxHQUFHLFNBQVMsQ0FBQyxJQUFJLENBQUMsTUFBTSxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDO0lBQ25ILENBQUM7SUFFRCxTQUFTLENBQUMsV0FBVyxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQ2pDLE9BQU8sUUFBUSxDQUFDO0FBQ2xCLENBQUM7QUFFRDs7Ozs7O0dBTUc7QUFDSCxTQUFTLGNBQWMsQ0FBQyxNQUF3QixFQUFFLFVBQXdCLEVBQUU7SUFDMUUsUUFBUSxDQUFDLGdCQUFnQixFQUFFLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztJQUU1QyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDO1FBQzNCLE1BQU0sS0FBSyxHQUFnQjtZQUN6QixPQUFPLEVBQUUsS0FBSztZQUNkLE9BQU8sRUFBRSxtREFBbUQ7WUFDNUQsT0FBTyxFQUFFLEVBQUU7WUFDWCxPQUFPLEVBQUUsRUFBRSxLQUFLLEVBQUUsQ0FBQyxFQUFFLFVBQVUsRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRTtTQUNoRCxDQUFDO1FBQ0YsU0FBUyxDQUFDLGdCQUFnQixFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ25DLE9BQU8sS0FBSyxDQUFDO0lBQ2YsQ0FBQztJQUVELE1BQU0sT0FBTyxHQUFvQixFQUFFLENBQUM7SUFDcEMsSUFBSSxVQUFVLEdBQUcsQ0FBQyxDQUFDO0lBQ25CLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQztJQUVmLGtDQUFrQztJQUNsQyxLQUFLLE1BQU0sS0FBSyxJQUFJLE1BQU0sRUFBRSxDQUFDO1FBQzNCLElBQUksQ0FBQztZQUNILE1BQU0sTUFBTSxHQUFHLFNBQVMsQ0FDdEIsS0FBSyxDQUFDLEVBQUUsSUFBSSxLQUFLLENBQUMsU0FBUyxJQUFJLEVBQUUsRUFDakMsS0FBSyxDQUFDLE9BQU8sRUFDYixLQUFLLENBQUMsSUFBSSxFQUNWLEVBQUUsR0FBRyxPQUFPLEVBQUUsR0FBRyxLQUFLLENBQUMsT0FBTyxFQUFFLENBQ2pDLENBQUM7WUFFRixPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ3JCLElBQUksTUFBTSxDQUFDLE9BQU8sRUFBRSxDQUFDO2dCQUNuQixVQUFVLEVBQUUsQ0FBQztZQUNmLENBQUM7aUJBQU0sQ0FBQztnQkFDTixNQUFNLEVBQUUsQ0FBQztZQUNYLENBQUM7UUFDSCxDQUFDO1FBQUMsT0FBTyxLQUFVLEVBQUUsQ0FBQztZQUNwQixNQUFNLFdBQVcsR0FBa0I7Z0JBQ2pDLE9BQU8sRUFBRSxLQUFLO2dCQUNkLFNBQVMsRUFBRSxJQUFJO2dCQUNmLE9BQU8sRUFBRSw0QkFBNEIsS0FBSyxDQUFDLE9BQU8sRUFBRTtnQkFDcEQsU0FBUyxFQUFFLElBQUksSUFBSSxFQUFFO2dCQUNyQixLQUFLLEVBQUUsa0JBQWtCO2FBQzFCLENBQUM7WUFFRixPQUFPLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBQzFCLE1BQU0sRUFBRSxDQUFDO1FBQ1gsQ0FBQztJQUNILENBQUM7SUFFRCxNQUFNLFdBQVcsR0FBZ0I7UUFDL0IsT0FBTyxFQUFFLE1BQU0sS0FBSyxDQUFDO1FBQ3JCLE9BQU87UUFDUCxPQUFPLEVBQUU7WUFDUCxLQUFLLEVBQUUsTUFBTSxDQUFDLE1BQU07WUFDcEIsVUFBVTtZQUNWLE1BQU07U0FDUDtLQUNGLENBQUM7SUFFRixJQUFJLE1BQU0sR0FBRyxDQUFDLEVBQUUsQ0FBQztRQUNmLFdBQVcsQ0FBQyxPQUFPLEdBQUcsd0JBQXdCLE1BQU0sb0JBQW9CLE1BQU0sQ0FBQyxNQUFNLFNBQVMsQ0FBQztJQUNqRyxDQUFDO1NBQU0sQ0FBQztRQUNOLFdBQVcsQ0FBQyxPQUFPLEdBQUcsa0NBQWtDLFVBQVUsbUJBQW1CLENBQUM7SUFDeEYsQ0FBQztJQUVELFNBQVMsQ0FBQyxnQkFBZ0IsRUFBRSxXQUFXLENBQUMsQ0FBQztJQUN6QyxPQUFPLFdBQVcsQ0FBQztBQUNyQixDQUFDO0FBRUQsZ0NBQWdDO0FBQ2hDLE9BQU8sRUFBRSxTQUFTLEVBQUUsY0FBYyxFQUFFLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS91dGlscy9lbWFpbC9lbWFpbFNlbmRlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEVtYWlsIFNlbmRlciBDb3JlIFV0aWxpdHkgLSBUeXBlU2NyaXB0IEltcGxlbWVudGF0aW9uXG4gKiBcbiAqIFRoaXMgbW9kdWxlIHByb3ZpZGVzIHRoZSBjb3JlIGVtYWlsIHNlbmRpbmcgZnVuY3Rpb25hbGl0eSBhbmQgYmF0Y2ggb3BlcmF0aW9ucy5cbiAqIEl0IGNvb3JkaW5hdGVzIHdpdGggb3RoZXIgZW1haWwgdXRpbGl0aWVzIGZvciB2YWxpZGF0aW9uLCBmb3JtYXR0aW5nLCBhbmQgaGlzdG9yeS5cbiAqL1xuXG5pbXBvcnQgeyBsb2dTdGFydCwgbG9nUmV0dXJuIH0gZnJvbSAnLi4vLi4vbGliL2xvZ1V0aWxzLmpzJztcbmltcG9ydCB7IHZhbGlkYXRlRW1haWwgfSBmcm9tICcuL2VtYWlsVmFsaWRhdG9yLmpzJztcbmltcG9ydCB7IGZvcm1hdEVtYWlsQ29udGVudCB9IGZyb20gJy4vZW1haWxGb3JtYXR0ZXIuanMnO1xuaW1wb3J0IHsgYWRkVG9IaXN0b3J5IH0gZnJvbSAnLi9lbWFpbEhpc3RvcnkuanMnO1xuXG4vLyBUeXBlIGRlZmluaXRpb25zXG5pbnRlcmZhY2UgRW1haWxPcHRpb25zIHtcbiAgdmVyYm9zZT86IGJvb2xlYW47XG4gIFtrZXk6IHN0cmluZ106IGFueTtcbn1cblxuaW50ZXJmYWNlIEVtYWlsUmVzcG9uc2Uge1xuICBzdWNjZXNzOiBib29sZWFuO1xuICBlbWFpbERhdGE/OiBhbnk7XG4gIG1lc3NhZ2U6IHN0cmluZztcbiAgdGltZXN0YW1wOiBEYXRlO1xuICBpZD86IHN0cmluZztcbiAgZXJyb3I/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBFbWFpbEJhdGNoSXRlbSB7XG4gIHRvPzogc3RyaW5nO1xuICByZWNpcGllbnQ/OiBzdHJpbmc7XG4gIHN1YmplY3Q6IHN0cmluZztcbiAgYm9keTogc3RyaW5nO1xuICBvcHRpb25zPzogRW1haWxPcHRpb25zO1xufVxuXG5pbnRlcmZhY2UgQmF0Y2hSZXN1bHQge1xuICBzdWNjZXNzOiBib29sZWFuO1xuICBtZXNzYWdlPzogc3RyaW5nO1xuICByZXN1bHRzOiBFbWFpbFJlc3BvbnNlW107XG4gIHN1bW1hcnk6IHtcbiAgICB0b3RhbDogbnVtYmVyO1xuICAgIHN1Y2Nlc3NmdWw6IG51bWJlcjtcbiAgICBmYWlsZWQ6IG51bWJlcjtcbiAgfTtcbn1cblxuLyoqXG4gKiBDb3JlIHNlbmRFbWFpbCBNb2NrIEZ1bmN0aW9uXG4gKlxuICogUHVycG9zZTogUHJlcGFyZXMgZW1haWwgZGF0YSBmb3IgZXh0ZXJuYWwgZGVsaXZlcnkgd2l0aG91dCBjb3VwbGluZyB0byBhIG1haWxpbmcgc2VydmljZS5cbiAqIFRoaXMgbGlnaHR3ZWlnaHQgYXBwcm9hY2ggYXZvaWRzIGFkZGl0aW9uYWwgZGVwZW5kZW5jaWVzIHdoaWxlIGVuYWJsaW5nIHRlc3RzIHRoYXQgZXhwZWN0XG4gKiBlbWFpbCBwYXlsb2FkcyBhbmQgY29tcHJlaGVuc2l2ZSB2ZXJpZmljYXRpb24gb2YgZW1haWwgd29ya2Zsb3dzLlxuICovXG5mdW5jdGlvbiBzZW5kRW1haWwocmVjaXBpZW50OiBzdHJpbmcsIHN1YmplY3Q6IHN0cmluZywgYm9keTogc3RyaW5nLCBvcHRpb25zOiBFbWFpbE9wdGlvbnMgPSB7fSk6IEVtYWlsUmVzcG9uc2Uge1xuICBsb2dTdGFydCgnc2VuZEVtYWlsJywgcmVjaXBpZW50LCBzdWJqZWN0LCBib2R5LCBvcHRpb25zKTtcbiAgXG4gIC8vIFZhbGlkYXRlIGlucHV0IHBhcmFtZXRlcnNcbiAgaWYgKCF2YWxpZGF0ZUVtYWlsKHJlY2lwaWVudCkpIHtcbiAgICBjb25zdCBlcnJvcjogRW1haWxSZXNwb25zZSA9IHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgZW1haWxEYXRhOiBudWxsLFxuICAgICAgbWVzc2FnZTogYEludmFsaWQgZW1haWwgYWRkcmVzczogJHtyZWNpcGllbnR9YCxcbiAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgIGVycm9yOiAnSU5WQUxJRF9SRUNJUElFTlQnXG4gICAgfTtcbiAgICBcbiAgICAvLyBTdG9yZSBmYWlsZWQgYXR0ZW1wdCBpbiBoaXN0b3J5IGZvciB0ZXN0aW5nXG4gICAgYWRkVG9IaXN0b3J5KGVycm9yKTtcbiAgICBcbiAgICBjb25zb2xlLmxvZyhgW01PQ0sgRU1BSUwgRVJST1JdIEludmFsaWQgcmVjaXBpZW50OiAke3JlY2lwaWVudH1gKTtcbiAgICBsb2dSZXR1cm4oJ3NlbmRFbWFpbCcsIGVycm9yKTtcbiAgICByZXR1cm4gZXJyb3I7XG4gIH1cbiAgXG4gIC8vIEZvcm1hdCBlbWFpbCBjb250ZW50XG4gIGNvbnN0IGZvcm1hdHRlZCA9IGZvcm1hdEVtYWlsQ29udGVudChzdWJqZWN0LCBib2R5KTtcbiAgXG4gIC8vIENyZWF0ZSBlbWFpbCBkYXRhIHN0cnVjdHVyZVxuICBjb25zdCBlbWFpbERhdGEgPSB7XG4gICAgdG86IHJlY2lwaWVudCxcbiAgICBzdWJqZWN0OiBmb3JtYXR0ZWQuc3ViamVjdCxcbiAgICBib2R5OiBmb3JtYXR0ZWQuYm9keSxcbiAgICAuLi5vcHRpb25zXG4gIH07XG4gIFxuICAvLyBDcmVhdGUgcmVzcG9uc2Ugb2JqZWN0XG4gIGNvbnN0IHJlc3BvbnNlOiBFbWFpbFJlc3BvbnNlID0ge1xuICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgZW1haWxEYXRhLFxuICAgIG1lc3NhZ2U6IFwiQ2xpZW50IHNob3VsZCBzZW5kIHRoaXMgZW1haWwgdXNpbmcgcHJlZmVycmVkIG1haWwgc2VydmljZVwiLFxuICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICBpZDogYG1vY2stZW1haWwtJHtEYXRlLm5vdygpfS0ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KX1gXG4gIH07XG4gIFxuICAvLyBTdG9yZSBpbiBoaXN0b3J5IGZvciB0ZXN0IHZlcmlmaWNhdGlvblxuICBhZGRUb0hpc3RvcnkocmVzcG9uc2UpO1xuICBcbiAgLy8gTG9nIGVtYWlsIGRldGFpbHMgZm9yIGRldmVsb3BtZW50IGFuZCBkZWJ1Z2dpbmdcbiAgY29uc29sZS5sb2coYFtNT0NLIEVNQUlMXSBUbzogJHtyZWNpcGllbnR9LCBTdWJqZWN0OiAke2Zvcm1hdHRlZC5zdWJqZWN0fWApO1xuICBpZiAob3B0aW9ucy52ZXJib3NlKSB7XG4gICAgY29uc29sZS5sb2coYFtNT0NLIEVNQUlMXSBCb2R5OiAke2Zvcm1hdHRlZC5ib2R5LnN1YnN0cmluZygwLCAxMDApfSR7Zm9ybWF0dGVkLmJvZHkubGVuZ3RoID4gMTAwID8gJy4uLicgOiAnJ31gKTtcbiAgfVxuICBcbiAgbG9nUmV0dXJuKCdzZW5kRW1haWwnLCByZXNwb25zZSk7XG4gIHJldHVybiByZXNwb25zZTtcbn1cblxuLyoqXG4gKiBTZW5kIG11bHRpcGxlIGVtYWlscyBpbiBiYXRjaFxuICogXG4gKiBUaGlzIGZ1bmN0aW9uIHByb3ZpZGVzIGVmZmljaWVudCBiYXRjaCBlbWFpbCBwcm9jZXNzaW5nIGZvciBhcHBsaWNhdGlvbnNcbiAqIHRoYXQgbmVlZCB0byBzZW5kIG11bHRpcGxlIGVtYWlscy4gSXQgcHJvY2Vzc2VzIGFsbCBlbWFpbHMgYW5kIHJldHVybnNcbiAqIGEgc3VtbWFyeSB3aXRoIGluZGl2aWR1YWwgcmVzdWx0cy5cbiAqL1xuZnVuY3Rpb24gc2VuZEVtYWlsQmF0Y2goZW1haWxzOiBFbWFpbEJhdGNoSXRlbVtdLCBvcHRpb25zOiBFbWFpbE9wdGlvbnMgPSB7fSk6IEJhdGNoUmVzdWx0IHtcbiAgbG9nU3RhcnQoJ3NlbmRFbWFpbEJhdGNoJywgZW1haWxzLCBvcHRpb25zKTtcbiAgXG4gIGlmICghQXJyYXkuaXNBcnJheShlbWFpbHMpKSB7XG4gICAgY29uc3QgZXJyb3I6IEJhdGNoUmVzdWx0ID0ge1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBtZXNzYWdlOiAnc2VuZEVtYWlsQmF0Y2ggcmVxdWlyZXMgYW4gYXJyYXkgb2YgZW1haWwgb2JqZWN0cycsXG4gICAgICByZXN1bHRzOiBbXSxcbiAgICAgIHN1bW1hcnk6IHsgdG90YWw6IDAsIHN1Y2Nlc3NmdWw6IDAsIGZhaWxlZDogMSB9XG4gICAgfTtcbiAgICBsb2dSZXR1cm4oJ3NlbmRFbWFpbEJhdGNoJywgZXJyb3IpO1xuICAgIHJldHVybiBlcnJvcjtcbiAgfVxuICBcbiAgY29uc3QgcmVzdWx0czogRW1haWxSZXNwb25zZVtdID0gW107XG4gIGxldCBzdWNjZXNzZnVsID0gMDtcbiAgbGV0IGZhaWxlZCA9IDA7XG4gIFxuICAvLyBQcm9jZXNzIGVhY2ggZW1haWwgaW5kaXZpZHVhbGx5XG4gIGZvciAoY29uc3QgZW1haWwgb2YgZW1haWxzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IHNlbmRFbWFpbChcbiAgICAgICAgZW1haWwudG8gfHwgZW1haWwucmVjaXBpZW50IHx8ICcnLFxuICAgICAgICBlbWFpbC5zdWJqZWN0LFxuICAgICAgICBlbWFpbC5ib2R5LFxuICAgICAgICB7IC4uLm9wdGlvbnMsIC4uLmVtYWlsLm9wdGlvbnMgfVxuICAgICAgKTtcbiAgICAgIFxuICAgICAgcmVzdWx0cy5wdXNoKHJlc3VsdCk7XG4gICAgICBpZiAocmVzdWx0LnN1Y2Nlc3MpIHtcbiAgICAgICAgc3VjY2Vzc2Z1bCsrO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZmFpbGVkKys7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3I6IGFueSkge1xuICAgICAgY29uc3QgZXJyb3JSZXN1bHQ6IEVtYWlsUmVzcG9uc2UgPSB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBlbWFpbERhdGE6IG51bGwsXG4gICAgICAgIG1lc3NhZ2U6IGBGYWlsZWQgdG8gcHJvY2VzcyBlbWFpbDogJHtlcnJvci5tZXNzYWdlfWAsXG4gICAgICAgIHRpbWVzdGFtcDogbmV3IERhdGUoKSxcbiAgICAgICAgZXJyb3I6ICdQUk9DRVNTSU5HX0VSUk9SJ1xuICAgICAgfTtcbiAgICAgIFxuICAgICAgcmVzdWx0cy5wdXNoKGVycm9yUmVzdWx0KTtcbiAgICAgIGZhaWxlZCsrO1xuICAgIH1cbiAgfVxuICBcbiAgY29uc3QgYmF0Y2hSZXN1bHQ6IEJhdGNoUmVzdWx0ID0ge1xuICAgIHN1Y2Nlc3M6IGZhaWxlZCA9PT0gMCxcbiAgICByZXN1bHRzLFxuICAgIHN1bW1hcnk6IHtcbiAgICAgIHRvdGFsOiBlbWFpbHMubGVuZ3RoLFxuICAgICAgc3VjY2Vzc2Z1bCxcbiAgICAgIGZhaWxlZFxuICAgIH1cbiAgfTtcbiAgXG4gIGlmIChmYWlsZWQgPiAwKSB7XG4gICAgYmF0Y2hSZXN1bHQubWVzc2FnZSA9IGBCYXRjaCBjb21wbGV0ZWQgd2l0aCAke2ZhaWxlZH0gZmFpbHVyZXMgb3V0IG9mICR7ZW1haWxzLmxlbmd0aH0gZW1haWxzYDtcbiAgfSBlbHNlIHtcbiAgICBiYXRjaFJlc3VsdC5tZXNzYWdlID0gYEJhdGNoIGNvbXBsZXRlZCBzdWNjZXNzZnVsbHkgLSAke3N1Y2Nlc3NmdWx9IGVtYWlscyBwcm9jZXNzZWRgO1xuICB9XG4gIFxuICBsb2dSZXR1cm4oJ3NlbmRFbWFpbEJhdGNoJywgYmF0Y2hSZXN1bHQpO1xuICByZXR1cm4gYmF0Y2hSZXN1bHQ7XG59XG5cbi8vIEV4cG9ydCB1c2luZyBFUyBtb2R1bGUgc3ludGF4XG5leHBvcnQgeyBzZW5kRW1haWwsIHNlbmRFbWFpbEJhdGNoIH07Il0sInZlcnNpb24iOjN9