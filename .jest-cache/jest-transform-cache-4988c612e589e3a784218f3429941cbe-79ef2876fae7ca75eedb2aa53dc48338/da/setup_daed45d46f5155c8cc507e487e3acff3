90a8e436c8805ab47af71b76a0aab7c1
"use strict";
/**
 * qtests Setup Module - Global Node.js Module Resolution Modification - TypeScript Implementation
 *
 * This module modifies Node.js's global module resolution behavior to automatically
 * substitute stub implementations for real modules during testing. It's a critical
 * piece of the qtests framework that enables seamless testing without changing
 * application code.
 *
 * Core functionality:
 * When this module is required, it patches Node.js's Module._resolveFilename method
 * to intercept require() calls and redirect them to stub implementations when
 * appropriate. This allows test code to use the same require() statements as
 * production code while getting test-appropriate implementations.
 *
 * Design philosophy:
 * - Transparent operation: Application code doesn't need to change
 * - Automatic stub resolution: No manual require() path changes needed
 * - Safe operation: Only affects specific modules, others work normally
 * - Performance conscious: Minimal overhead on module resolution
 *
 * Security and safety considerations:
 * - Only affects modules in the predefined stub registry
 * - Original Node.js behavior preserved for unlisted modules
 * - Changes are temporary and isolated to test execution
 * - No permanent modifications to Node.js installation
 * - Easy to disable by not requiring this module
 */
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.setupComplete = void 0;
// Import Node.js Module constructor for accessing module resolution internals
// This gives us access to the private _resolveFilename method that controls
// how Node.js resolves module names to file paths
const module_1 = __importDefault(require("module"));
const path_1 = __importDefault(require("path"));
const esm_globals_js_1 = require("./utils/esm-globals.js");
// Get current directory for ES modules
const moduleDirname = (0, esm_globals_js_1.getModuleDirname)(import.meta.url);
const stubsPath = path_1.default.join(moduleDirname, 'stubs');
const STUB_REGISTRY = {
    axios: 'axios.js', // HTTP client library stub file name for quick lookup
    winston: 'winston.js' // logging library stub file name for quick lookup
};
// Preserve existing NODE_PATH if it exists
const currentNodePath = process.env.NODE_PATH || '';
// Determine correct path separator for current platform
const separator = process.platform === 'win32' ? ';' : ':';
// Prepend our stubs directory to NODE_PATH
process.env.NODE_PATH = stubsPath + (currentNodePath ? separator + currentNodePath : '');
// Force Node.js to recognize the updated NODE_PATH for dynamic module resolution
module_1.default._initPaths();
// Store original Module._load function for delegation to maintain normal module loading behavior
const origLoad = module_1.default._load;
/**
 * Enhanced Module._load replacement that handles stub substitution
 *
 * This function intercepts all module loading requests and redirects known
 * modules to their stub implementations when appropriate.
 */
module_1.default._load = function (id, parent, isMain) {
    // Check if this module should be stubbed
    if (STUB_REGISTRY[id]) {
        const stubPath = path_1.default.join(stubsPath, STUB_REGISTRY[id]);
        try {
            // Load the stub module instead of the real one
            return origLoad.call(this, stubPath, parent, isMain);
        }
        catch (error) {
            console.log(`qtests: Failed to load stub for ${id} from ${stubPath}, falling back to original`);
            // Fall back to original module if stub loading fails
            return origLoad.call(this, id, parent, isMain);
        }
    }
    // For non-stubbed modules, use original behavior
    return origLoad.call(this, id, parent, isMain);
};
console.log('qtests: Global module resolution patching activated');
console.log(`qtests: Stub registry contains: ${Object.keys(STUB_REGISTRY).join(', ')}`);
console.log(`qtests: Stubs directory: ${stubsPath}`);
// Export setup completion indicator
exports.setupComplete = true;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL2hvbWUvcnVubmVyL3dvcmtzcGFjZS9zZXR1cC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0dBMEJHOzs7Ozs7QUFFSCw4RUFBOEU7QUFDOUUsNEVBQTRFO0FBQzVFLGtEQUFrRDtBQUNsRCxvREFBNEI7QUFDNUIsZ0RBQXdCO0FBQ3hCLDJEQUEwRDtBQUUxRCx1Q0FBdUM7QUFDdkMsTUFBTSxhQUFhLEdBQUcsSUFBQSxpQ0FBZ0IsRUFBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0FBQ3hELE1BQU0sU0FBUyxHQUFHLGNBQUksQ0FBQyxJQUFJLENBQUMsYUFBYSxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBYXBELE1BQU0sYUFBYSxHQUFpQjtJQUNsQyxLQUFLLEVBQUUsVUFBVSxFQUFFLHNEQUFzRDtJQUN6RSxPQUFPLEVBQUUsWUFBWSxDQUFDLGtEQUFrRDtDQUN6RSxDQUFDO0FBRUYsMkNBQTJDO0FBQzNDLE1BQU0sZUFBZSxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQztBQUVwRCx3REFBd0Q7QUFDeEQsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLFFBQVEsS0FBSyxPQUFPLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDO0FBRTNELDJDQUEyQztBQUMzQyxPQUFPLENBQUMsR0FBRyxDQUFDLFNBQVMsR0FBRyxTQUFTLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQyxDQUFDLFNBQVMsR0FBRyxlQUFlLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBRXpGLGlGQUFpRjtBQUNoRixnQkFBYyxDQUFDLFVBQVUsRUFBRSxDQUFDO0FBRTdCLGlHQUFpRztBQUNqRyxNQUFNLFFBQVEsR0FBSSxnQkFBYyxDQUFDLEtBQUssQ0FBQztBQUV2Qzs7Ozs7R0FLRztBQUNGLGdCQUFjLENBQUMsS0FBSyxHQUFHLFVBQVMsRUFBVSxFQUFFLE1BQVcsRUFBRSxNQUFnQjtJQUN4RSx5Q0FBeUM7SUFDekMsSUFBSSxhQUFhLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQztRQUN0QixNQUFNLFFBQVEsR0FBRyxjQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxhQUFhLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztRQUN6RCxJQUFJLENBQUM7WUFDSCwrQ0FBK0M7WUFDL0MsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ3ZELENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsRUFBRSxTQUFTLFFBQVEsNEJBQTRCLENBQUMsQ0FBQztZQUNoRyxxREFBcUQ7WUFDckQsT0FBTyxRQUFRLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1FBQ2pELENBQUM7SUFDSCxDQUFDO0lBRUQsaURBQWlEO0lBQ2pELE9BQU8sUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQztBQUNqRCxDQUFDLENBQUM7QUFFRixPQUFPLENBQUMsR0FBRyxDQUFDLHFEQUFxRCxDQUFDLENBQUM7QUFDbkUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQ0FBbUMsTUFBTSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3hGLE9BQU8sQ0FBQyxHQUFHLENBQUMsNEJBQTRCLFNBQVMsRUFBRSxDQUFDLENBQUM7QUFFckQsb0NBQW9DO0FBQ3ZCLFFBQUEsYUFBYSxHQUFHLElBQUksQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvaG9tZS9ydW5uZXIvd29ya3NwYWNlL3NldHVwLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogcXRlc3RzIFNldHVwIE1vZHVsZSAtIEdsb2JhbCBOb2RlLmpzIE1vZHVsZSBSZXNvbHV0aW9uIE1vZGlmaWNhdGlvbiAtIFR5cGVTY3JpcHQgSW1wbGVtZW50YXRpb25cbiAqIFxuICogVGhpcyBtb2R1bGUgbW9kaWZpZXMgTm9kZS5qcydzIGdsb2JhbCBtb2R1bGUgcmVzb2x1dGlvbiBiZWhhdmlvciB0byBhdXRvbWF0aWNhbGx5XG4gKiBzdWJzdGl0dXRlIHN0dWIgaW1wbGVtZW50YXRpb25zIGZvciByZWFsIG1vZHVsZXMgZHVyaW5nIHRlc3RpbmcuIEl0J3MgYSBjcml0aWNhbFxuICogcGllY2Ugb2YgdGhlIHF0ZXN0cyBmcmFtZXdvcmsgdGhhdCBlbmFibGVzIHNlYW1sZXNzIHRlc3Rpbmcgd2l0aG91dCBjaGFuZ2luZ1xuICogYXBwbGljYXRpb24gY29kZS5cbiAqIFxuICogQ29yZSBmdW5jdGlvbmFsaXR5OlxuICogV2hlbiB0aGlzIG1vZHVsZSBpcyByZXF1aXJlZCwgaXQgcGF0Y2hlcyBOb2RlLmpzJ3MgTW9kdWxlLl9yZXNvbHZlRmlsZW5hbWUgbWV0aG9kXG4gKiB0byBpbnRlcmNlcHQgcmVxdWlyZSgpIGNhbGxzIGFuZCByZWRpcmVjdCB0aGVtIHRvIHN0dWIgaW1wbGVtZW50YXRpb25zIHdoZW5cbiAqIGFwcHJvcHJpYXRlLiBUaGlzIGFsbG93cyB0ZXN0IGNvZGUgdG8gdXNlIHRoZSBzYW1lIHJlcXVpcmUoKSBzdGF0ZW1lbnRzIGFzXG4gKiBwcm9kdWN0aW9uIGNvZGUgd2hpbGUgZ2V0dGluZyB0ZXN0LWFwcHJvcHJpYXRlIGltcGxlbWVudGF0aW9ucy5cbiAqIFxuICogRGVzaWduIHBoaWxvc29waHk6XG4gKiAtIFRyYW5zcGFyZW50IG9wZXJhdGlvbjogQXBwbGljYXRpb24gY29kZSBkb2Vzbid0IG5lZWQgdG8gY2hhbmdlXG4gKiAtIEF1dG9tYXRpYyBzdHViIHJlc29sdXRpb246IE5vIG1hbnVhbCByZXF1aXJlKCkgcGF0aCBjaGFuZ2VzIG5lZWRlZFxuICogLSBTYWZlIG9wZXJhdGlvbjogT25seSBhZmZlY3RzIHNwZWNpZmljIG1vZHVsZXMsIG90aGVycyB3b3JrIG5vcm1hbGx5XG4gKiAtIFBlcmZvcm1hbmNlIGNvbnNjaW91czogTWluaW1hbCBvdmVyaGVhZCBvbiBtb2R1bGUgcmVzb2x1dGlvblxuICogXG4gKiBTZWN1cml0eSBhbmQgc2FmZXR5IGNvbnNpZGVyYXRpb25zOlxuICogLSBPbmx5IGFmZmVjdHMgbW9kdWxlcyBpbiB0aGUgcHJlZGVmaW5lZCBzdHViIHJlZ2lzdHJ5XG4gKiAtIE9yaWdpbmFsIE5vZGUuanMgYmVoYXZpb3IgcHJlc2VydmVkIGZvciB1bmxpc3RlZCBtb2R1bGVzXG4gKiAtIENoYW5nZXMgYXJlIHRlbXBvcmFyeSBhbmQgaXNvbGF0ZWQgdG8gdGVzdCBleGVjdXRpb25cbiAqIC0gTm8gcGVybWFuZW50IG1vZGlmaWNhdGlvbnMgdG8gTm9kZS5qcyBpbnN0YWxsYXRpb25cbiAqIC0gRWFzeSB0byBkaXNhYmxlIGJ5IG5vdCByZXF1aXJpbmcgdGhpcyBtb2R1bGVcbiAqL1xuXG4vLyBJbXBvcnQgTm9kZS5qcyBNb2R1bGUgY29uc3RydWN0b3IgZm9yIGFjY2Vzc2luZyBtb2R1bGUgcmVzb2x1dGlvbiBpbnRlcm5hbHNcbi8vIFRoaXMgZ2l2ZXMgdXMgYWNjZXNzIHRvIHRoZSBwcml2YXRlIF9yZXNvbHZlRmlsZW5hbWUgbWV0aG9kIHRoYXQgY29udHJvbHNcbi8vIGhvdyBOb2RlLmpzIHJlc29sdmVzIG1vZHVsZSBuYW1lcyB0byBmaWxlIHBhdGhzXG5pbXBvcnQgTW9kdWxlIGZyb20gJ21vZHVsZSc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGdldE1vZHVsZURpcm5hbWUgfSBmcm9tICcuL3V0aWxzL2VzbS1nbG9iYWxzLmpzJztcblxuLy8gR2V0IGN1cnJlbnQgZGlyZWN0b3J5IGZvciBFUyBtb2R1bGVzXG5jb25zdCBtb2R1bGVEaXJuYW1lID0gZ2V0TW9kdWxlRGlybmFtZShpbXBvcnQubWV0YS51cmwpO1xuY29uc3Qgc3R1YnNQYXRoID0gcGF0aC5qb2luKG1vZHVsZURpcm5hbWUsICdzdHVicycpO1xuXG4vKipcbiAqIE1vZHVsZSBzdHViIHJlZ2lzdHJ5IC0gZGVmaW5lcyB3aGljaCBtb2R1bGVzIHNob3VsZCBiZSByZXBsYWNlZCB3aXRoIHN0dWJzXG4gKiBcbiAqIFRoaXMgb2JqZWN0IG1hcHMgcmVhbCBtb2R1bGUgbmFtZXMgdG8gdGhlaXIgc3R1YiBpbXBsZW1lbnRhdGlvbiBwYXRocy5cbiAqIFdoZW4gTm9kZS5qcyBhdHRlbXB0cyB0byByZXNvbHZlIGEgbW9kdWxlIGxpc3RlZCBpbiB0aGlzIHJlZ2lzdHJ5LFxuICogdGhlIHN0dWIgcGF0aCB3aWxsIGJlIHJldHVybmVkIGluc3RlYWQgb2YgdGhlIHJlYWwgbW9kdWxlIHBhdGguXG4gKi9cbmludGVyZmFjZSBTdHViUmVnaXN0cnkge1xuICBbbW9kdWxlTmFtZTogc3RyaW5nXTogc3RyaW5nO1xufVxuXG5jb25zdCBTVFVCX1JFR0lTVFJZOiBTdHViUmVnaXN0cnkgPSB7XG4gIGF4aW9zOiAnYXhpb3MuanMnLCAvLyBIVFRQIGNsaWVudCBsaWJyYXJ5IHN0dWIgZmlsZSBuYW1lIGZvciBxdWljayBsb29rdXBcbiAgd2luc3RvbjogJ3dpbnN0b24uanMnIC8vIGxvZ2dpbmcgbGlicmFyeSBzdHViIGZpbGUgbmFtZSBmb3IgcXVpY2sgbG9va3VwXG59O1xuXG4vLyBQcmVzZXJ2ZSBleGlzdGluZyBOT0RFX1BBVEggaWYgaXQgZXhpc3RzXG5jb25zdCBjdXJyZW50Tm9kZVBhdGggPSBwcm9jZXNzLmVudi5OT0RFX1BBVEggfHwgJyc7XG5cbi8vIERldGVybWluZSBjb3JyZWN0IHBhdGggc2VwYXJhdG9yIGZvciBjdXJyZW50IHBsYXRmb3JtXG5jb25zdCBzZXBhcmF0b3IgPSBwcm9jZXNzLnBsYXRmb3JtID09PSAnd2luMzInID8gJzsnIDogJzonO1xuXG4vLyBQcmVwZW5kIG91ciBzdHVicyBkaXJlY3RvcnkgdG8gTk9ERV9QQVRIXG5wcm9jZXNzLmVudi5OT0RFX1BBVEggPSBzdHVic1BhdGggKyAoY3VycmVudE5vZGVQYXRoID8gc2VwYXJhdG9yICsgY3VycmVudE5vZGVQYXRoIDogJycpO1xuXG4vLyBGb3JjZSBOb2RlLmpzIHRvIHJlY29nbml6ZSB0aGUgdXBkYXRlZCBOT0RFX1BBVEggZm9yIGR5bmFtaWMgbW9kdWxlIHJlc29sdXRpb25cbihNb2R1bGUgYXMgYW55KS5faW5pdFBhdGhzKCk7XG5cbi8vIFN0b3JlIG9yaWdpbmFsIE1vZHVsZS5fbG9hZCBmdW5jdGlvbiBmb3IgZGVsZWdhdGlvbiB0byBtYWludGFpbiBub3JtYWwgbW9kdWxlIGxvYWRpbmcgYmVoYXZpb3JcbmNvbnN0IG9yaWdMb2FkID0gKE1vZHVsZSBhcyBhbnkpLl9sb2FkO1xuXG4vKipcbiAqIEVuaGFuY2VkIE1vZHVsZS5fbG9hZCByZXBsYWNlbWVudCB0aGF0IGhhbmRsZXMgc3R1YiBzdWJzdGl0dXRpb25cbiAqIFxuICogVGhpcyBmdW5jdGlvbiBpbnRlcmNlcHRzIGFsbCBtb2R1bGUgbG9hZGluZyByZXF1ZXN0cyBhbmQgcmVkaXJlY3RzIGtub3duXG4gKiBtb2R1bGVzIHRvIHRoZWlyIHN0dWIgaW1wbGVtZW50YXRpb25zIHdoZW4gYXBwcm9wcmlhdGUuXG4gKi9cbihNb2R1bGUgYXMgYW55KS5fbG9hZCA9IGZ1bmN0aW9uKGlkOiBzdHJpbmcsIHBhcmVudDogYW55LCBpc01haW4/OiBib29sZWFuKTogYW55IHtcbiAgLy8gQ2hlY2sgaWYgdGhpcyBtb2R1bGUgc2hvdWxkIGJlIHN0dWJiZWRcbiAgaWYgKFNUVUJfUkVHSVNUUllbaWRdKSB7XG4gICAgY29uc3Qgc3R1YlBhdGggPSBwYXRoLmpvaW4oc3R1YnNQYXRoLCBTVFVCX1JFR0lTVFJZW2lkXSk7XG4gICAgdHJ5IHtcbiAgICAgIC8vIExvYWQgdGhlIHN0dWIgbW9kdWxlIGluc3RlYWQgb2YgdGhlIHJlYWwgb25lXG4gICAgICByZXR1cm4gb3JpZ0xvYWQuY2FsbCh0aGlzLCBzdHViUGF0aCwgcGFyZW50LCBpc01haW4pO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmxvZyhgcXRlc3RzOiBGYWlsZWQgdG8gbG9hZCBzdHViIGZvciAke2lkfSBmcm9tICR7c3R1YlBhdGh9LCBmYWxsaW5nIGJhY2sgdG8gb3JpZ2luYWxgKTtcbiAgICAgIC8vIEZhbGwgYmFjayB0byBvcmlnaW5hbCBtb2R1bGUgaWYgc3R1YiBsb2FkaW5nIGZhaWxzXG4gICAgICByZXR1cm4gb3JpZ0xvYWQuY2FsbCh0aGlzLCBpZCwgcGFyZW50LCBpc01haW4pO1xuICAgIH1cbiAgfVxuICBcbiAgLy8gRm9yIG5vbi1zdHViYmVkIG1vZHVsZXMsIHVzZSBvcmlnaW5hbCBiZWhhdmlvclxuICByZXR1cm4gb3JpZ0xvYWQuY2FsbCh0aGlzLCBpZCwgcGFyZW50LCBpc01haW4pO1xufTtcblxuY29uc29sZS5sb2coJ3F0ZXN0czogR2xvYmFsIG1vZHVsZSByZXNvbHV0aW9uIHBhdGNoaW5nIGFjdGl2YXRlZCcpO1xuY29uc29sZS5sb2coYHF0ZXN0czogU3R1YiByZWdpc3RyeSBjb250YWluczogJHtPYmplY3Qua2V5cyhTVFVCX1JFR0lTVFJZKS5qb2luKCcsICcpfWApO1xuY29uc29sZS5sb2coYHF0ZXN0czogU3R1YnMgZGlyZWN0b3J5OiAke3N0dWJzUGF0aH1gKTtcblxuLy8gRXhwb3J0IHNldHVwIGNvbXBsZXRpb24gaW5kaWNhdG9yXG5leHBvcnQgY29uc3Qgc2V0dXBDb21wbGV0ZSA9IHRydWU7Il0sInZlcnNpb24iOjN9