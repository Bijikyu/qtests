/**
 * Test Mock Factory - Consolidated Mocking Utilities
 * 
 * This factory provides centralized mocking for external dependencies
 * to eliminate duplication across test setup files.
 * 
 * Key Features:
 * - Single source of truth for all test mocks
 * - Consistent mock configuration across test files
 * - Easy to extend with new mock patterns
 * - Memory-efficient test environment setup
 */

const { jest } = require('@jest/globals');

/**
 * Default test configuration
 */
const DEFAULT_TEST_CONFIG = {
  PORT: 0,
  SECURITY: {
    REQUIRE_API_KEY: false,
    API_KEY: 'test-integration-api-key-1234567890'
  },
  RATE_LIMITING: {
    ENABLED: false,
    WINDOW_MS: 900000,
    MAX_REQUESTS: 1000
  },
  TENSORFLOW: {
    ENABLE_MODEL_CACHING: false, // Disable for memory efficiency
    MAX_MODEL_SIZE: 50 * 1024 * 1024, // 50MB limit
    CLEANUP_INTERVAL: 30000
  }
};

/**
 * Test Mock Factory Class
 */
class TestMockFactory {
  constructor() {
    this.mocksCreated = false;
  }

  /**
   * Create all test mocks - call this before importing modules that use mocks
   */
  createAllMocks(config = {}) {
    if (this.mocksCreated) {
      console.warn('Test mocks already created - skipping duplicate creation');
      return;
    }

    const finalConfig = { ...DEFAULT_TEST_CONFIG, ...config };

    this.mockConfig(finalConfig);
    this.mockFaceApi();
    this.mockTensorFlow();

    this.mocksCreated = true;
  }

  /**
   * Mock configuration module
   */
  mockConfig(config) {
    jest.doMock('../../config/localVars.js', () => config);
  }

  /**
   * Mock Face API module
   */
  mockFaceApi() {
    jest.doMock('@vladmandic/face-api', () => {
      const mockFaceApi = {
        detectAllFaces: jest.fn(() => Promise.resolve([])),
        detectSingleFace: jest.fn(() => Promise.resolve(null)),
        createCanvas: jest.fn(() => ({})),
        fetchImage: jest.fn(() => Promise.resolve({})),
        nets: {
          ssdMobilenetv1: { loadFromUri: jest.fn(() => Promise.resolve({})) },
          faceLandmark68Net: { loadFromUri: jest.fn(() => Promise.resolve({})) },
          faceRecognitionNet: { loadFromUri: jest.fn(() => Promise.resolve({})) }
        }
      };

      return mockFaceApi;
    });
  }

  /**
   * Mock TensorFlow module
   */
  mockTensorFlow() {
    jest.doMock('@tensorflow/tfjs-node', () => {
      const mockTensorFlow = {
        node: {
          bindEnvironment: jest.fn(),
          enableProdMode: jest.fn(),
          disposeVariables: jest.fn()
        }
      };

      return mockTensorFlow;
    });
  }

  /**
   * Reset all mocks for clean test environment
   */
  resetMocks() {
    jest.resetModules();
    jest.clearAllMocks();
    this.mocksCreated = false;
  }

  /**
   * Get mock instances for test configuration
   */
  getMockFaceApi() {
    const faceApi = require('@vladmandic/face-api');
    return faceApi;
  }

  /**
   * Get mock TensorFlow instance
   */
  getMockTensorFlow() {
    const tensorflow = require('@tensorflow/tfjs-node');
    return tensorflow;
  }

  /**
   * Get mock configuration
   */
  getMockConfig() {
    const config = require('../../config/localVars.js');
    return config;
  }
}

// Singleton instance
const factory = new TestMockFactory();

/**
 * Convenience function for creating test mocks
 * 
 * @param config - Optional configuration overrides
 * @returns Test mock factory instance
 */
function createTestMocks(config) {
  factory.createAllMocks(config);
  return factory;
}

/**
 * Quick setup function for most common use case
 */
function setupTestEnvironment(config) {
  createTestMocks(config);
}

module.exports = {
  TestMockFactory,
  createTestMocks,
  setupTestEnvironment,
  DEFAULT_TEST_CONFIG,
  factory
};