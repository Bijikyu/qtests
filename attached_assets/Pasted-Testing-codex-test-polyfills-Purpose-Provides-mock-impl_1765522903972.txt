Testing
@codex/test-polyfills
Purpose: Provides mock implementations of browser APIs for testing environments where native APIs are unavailable. Explanation:
This module offers a collection of test polyfills that mock browser APIs like Clipboard, IntersectionObserver, MatchMedia, and ResizeObserver. These are essential for testing frontend components in Node.js environments where these APIs don't naturally exist. The polyfills provide consistent, minimal implementations that allow tests to run without errors while maintaining the same API surface as the native browser implementations.

The module solves the common problem of browser API testing gaps in Jest/Vitest environments, provides a standardized way to set up test mocks across different testing frameworks, and includes setup functions that return spy objects for test verification.

/**
 * Clipboard Mock for Testing
 * 
 * Provides a mock implementation of clipboard API for test environments
 * where native API is not available.
 */
export function setupClipboard(globalScope = globalThis) {
  const mockFactory = globalScope.jest?.fn ?? globalScope.vi?.fn ?? (() => () => undefined);
  const clipboardWriteTextSpy = mockFactory(async () => undefined);
  
  if (!globalScope.navigator) {
    globalScope.navigator = {};
  }
  globalScope.navigator.clipboard = { writeText: clipboardWriteTextSpy };
  
  return { clipboardWriteTextSpy };
}
/**
 * Intersection Observer Mock for Testing
 * 
 * Provides a mock implementation of IntersectionObserver for test environments
 * where native API is not available.
 */
export function setupIntersectionObserver(globalScope = globalThis) {
  const mockIntersectionObserver = class MockIntersectionObserver {
    constructor(_callback, _options) {
      this.root = null;
      this.rootMargin = '';
      this.thresholds = [];
    }
    observe() { return undefined; }
    unobserve() { return undefined; }
    disconnect() { return undefined; }
    takeRecords() { return []; }
    root;
    rootMargin;
    thresholds;
  };
  
  globalScope.IntersectionObserver = mockIntersectionObserver;
  return globalScope.IntersectionObserver;
}
/**
 * MatchMedia Mock for Testing
 * 
 * Provides a mock implementation of window.matchMedia for test environments
 * where native API is not available.
 */
export function setupMatchMedia(globalScope = globalThis) {
  if (typeof globalScope.window !== 'undefined' && !globalScope.window.matchMedia) {
    globalScope.window.matchMedia = query => ({
      matches: false,
      media: query,
      onchange: null,
      addListener: () => undefined,
      removeListener: () => undefined,
      addEventListener: () => undefined,
      removeEventListener: () => undefined,
      dispatchEvent: () => false,
    });
  }
}
/**
 * Resize Observer Mock for Testing
 * 
 * Provides a mock implementation of ResizeObserver for test environments
 * where the native API is not available.
 */
export function setupResizeObserver(globalScope = globalThis) {
  if (typeof globalScope.ResizeObserver !== 'function') {
    const mockResizeObserver = class MockResizeObserver {
      constructor(callback) {
        this.callback = callback;
      }
      observe() { return undefined; }
      unobserve() { return undefined; }
      disconnect() { return undefined; }
      callback;
    };
    globalScope.ResizeObserver = mockResizeObserver;
  }
  return globalScope.ResizeObserver;
}
/**
 * Test Polyfills Barrel Export
 * 
 * Provides access to all test polyfills from a single location
 * for backward compatibility with existing imports.
 */
export { setupResizeObserver } from './resizeObserver.js';
export { setupIntersectionObserver } from './intersectionObserver.js';
export { setupClipboard } from './clipboard.js';
export { setupMatchMedia } from './matchMedia.js';