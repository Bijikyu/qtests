#!/usr/bin/env tsx

/**
 * qtests Test Generator CLI - TypeScript ES Module Compatible
 * 
 * Command-line interface for generating unit tests and API tests
 * by scanning source code and analyzing exports, imports, and routes.
 */

import { TestGenerator } from '../lib/testGenerator.js';
import { readFileSync } from 'fs';
import { fileURLToPath } from 'url';
import path from 'path';

// Get __dirname equivalent for ES modules
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

// Parse command line arguments
function parseArgs(argv) {
  const args = argv.slice(2);
  const options = {};
  
  for (let i = 0; i < args.length; i++) {
    const arg = args[i];
    
    switch (arg) {
      case '--src':
      case '-s':
        options.SRC_DIR = args[++i];
        break;
      case '--test-dir':
      case '-t':
        options.TEST_DIR = args[++i];
        break;
      case '--help':
      case '-h':
        showHelp();
        process.exit(0);
        break;
      case '--version':
      case '-v':
        showVersion();
        process.exit(0);
        break;

      default:
        if (arg.startsWith('-')) {
          console.error(`Unknown option: ${arg}`);
          process.exit(1);
        }
    }
  }
  
  return options;
}

function showHelp() {
  console.log(`
qtests Test Generator

USAGE:
  qtests-generate [OPTIONS]

OPTIONS:
  -s, --src <dir>       Source directory to scan (default: src)
  -t, --test-dir <dir>  Generated test directory (default: generated-tests)

  -h, --help           Show this help message
  -v, --version        Show version information

EXAMPLES:
  qtests-generate                    # Scan 'src' directory with defaults
  qtests-generate --src lib          # Scan 'lib' directory instead
  qtests-generate -s app -t tests    # Custom source and test directories


DESCRIPTION:
  Automatically generates TypeScript unit tests and API tests by scanning 
  JavaScript/TypeScript source files. Detects exported functions, classes, 
  and Express routes to create appropriate test files with proper mocking setup.

  Generated test files:
  - Unit tests: Created alongside source files with .test.ts extension
  - API tests: Created in integration test directory with route-specific names
  - Jest configuration: Automatically creates jest.config.js and test setup files

For more information, visit: https://github.com/qtests/qtests
`);
}

function showVersion() {
  try {
    const packageJsonPath = path.join(__dirname, '..', 'package.json');
    const packageJson = JSON.parse(readFileSync(packageJsonPath, 'utf8'));
    console.log(`qtests v${packageJson.version}`);
  } catch (error) {
    console.log(`qtests v1.2.0`);
  }
}

async function main() {
  try {
    console.log('üîß qtests Test Generator (TypeScript ES Module)\n');
    
    const options = parseArgs(process.argv);
    const generator = new TestGenerator(options);
    
    // Display configuration
    console.log(`Configuration:`);
    console.log(`  Source directory: ${generator.config?.SRC_DIR || 'src'}`);
    console.log(`  Test directory: ${generator.config?.TEST_DIR || 'tests/integration'}`);
    console.log(`  Module system: TypeScript ES Modules (only)`);
    console.log('');
    
    // Generate tests
    await generator.generateTestFiles();
    const results = generator.getResults();
    
    // Summary
    console.log('\nüìä Generation Summary:');
    const unitTests = results.filter(r => r.type === 'unit').length;
    const apiTests = results.filter(r => r.type === 'api').length;
    
    console.log(`  Unit tests: ${unitTests}`);
    console.log(`  API tests: ${apiTests}`);
    console.log(`  Total files: ${results.length}`);
    
    if (results.length > 0) {
      console.log('\nüí° Next steps:');
      console.log('  1. Review generated TypeScript test files');
      console.log('  2. Add specific test implementations');
      console.log('  3. Run tests with: npm test');
    } else {
      console.log('\n‚úÖ All source files already have corresponding tests');
    }
    
  } catch (error) {
    console.error('‚ùå Error generating tests:', error.message);
    process.exit(1);
  }
}

// Run CLI if this script is executed directly
main().catch(error => {
  console.error('‚ùå Unexpected error:', error.message);
  process.exit(1);
});